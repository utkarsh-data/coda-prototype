<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoDA: Cognitive Data Assistant Prototype</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (for body) & Roboto Mono (for code) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto+Mono:400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js CDN for graphing - UPDATED to a specific v4.x version to avoid 'extend' errors from deprecated methods -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Define CSS Variables for Theming */
        :root {
            /* Default 'White and Blue' Theme */
            --bg-primary: #f8fafc; /* Light background */
            --bg-secondary: #ffffff; /* Pure white for panels */
            --text-primary: #1a202c; /* Dark text */
            --text-secondary: #4a5568; /* Slightly lighter dark text */
            --accent-primary: #3b82f6; /* Blue */
            --accent-secondary: #2563eb; /* Darker blue */
            --accent-primary-rgb: 59, 130, 246; /* RGB for blue accent for shadows */
            --border-color: #e2e8f0; /* Light grey border */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --bubble-color: rgba(0, 0, 0, 0.02); /* Very subtle light bubbles */
            --chat-bubble-ai: #e2e8f0; /* Light grey for AI bubble */
            --chat-bubble-user: #3b82f6; /* Accent blue for user bubble */
            --code-bg: #f1f5f9; /* Very light grey code background */
            --code-text: #1a202c; /* Dark code text */
            --code-border: #3b82f6; /* Accent blue for code border */
            --table-header-bg: #f0f4f8; /* Light grey table header */
            --table-header-text: #2d3748; /* Dark text for table header */
            --table-row-hover: #e2e8f0; /* Slightly darker hover for light theme */
            --category-header-bg: rgba(59, 130, 246, 0.1); /* Slightly transparent accent */
            --category-header-text: #1a202c; /* Darker text */
            --filter-active-bg: #3b82f6; /* Accent blue */
            --filter-active-text: #ffffff; /* White text */
            --filter-inactive-bg: #e2e8f0; /* Light grey */
            --filter-inactive-text: #2d3748; /* Dark text */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            overflow: hidden;
            position: relative;
        }

        /* Subtle background animation - Bubbles adapted for light theme */
        .background-bubbles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .bubble {
            background-color: var(--bubble-color);
            border-radius: 50%;
            position: absolute;
            animation: bubble-flow 20s infinite alternate ease-in-out;
            filter: blur(5px); /* Soften the bubbles */
        }

        .bubble:nth-child(1) { width: 80px; height: 80px; left: 15%; top: 10%; animation-duration: 22s; opacity: 0.05; }
        .bubble:nth-child(2) { width: 120px; height: 120px; left: 35%; top: 80%; animation-duration: 25s; opacity: 0.04; }
        .bubble:nth-child(3) { width: 90px; height: 90px; left: 70%; top: 15%; animation-duration: 19s; opacity: 0.06; }
        .bubble:nth-child(4) { width: 140px; height: 140px; left: 90%; top: 50%; animation-duration: 28s; opacity: 0.03; }
        .bubble:nth-child(5) { width: 70px; height: 70px; left: 5%; top: 60%; animation-duration: 21s; opacity: 0.07; }
        .bubble:nth-child(6) { width: 100px; height: 100px; left: 50%; top: 30%; animation-duration: 23s; opacity: 0.05; }

        @keyframes bubble-flow {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(70px, -70px) scale(1.1); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* Main Container Styling */
        #main-container {
            background-color: var(--bg-secondary); /* Use secondary background for main container */
            border: 1px solid var(--border-color); /* Use border color variable */
            box-shadow: 0 25px 50px -12px var(--shadow-color); /* Use shadow color variable */
            color: var(--text-primary); /* Use primary text color */
        }

        /* Left Pane Styling */
        #data-panel {
            border-right: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            /* Smoother panel transitions */
            transition: width 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        #data-panel.hidden {
            width: 0;
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }
        #data-panel.flex {
            width: 33.333333%; /* md:w-1/3 */
            opacity: 1;
            pointer-events: all;
        }

        #data-panel h2 {
            color: var(--accent-primary);
        }
        #data-panel p {
            color: var(--text-secondary);
        }
        #data-panel .font-semibold {
            color: var(--accent-primary);
        }

        #data-panel .border-dashed {
            border-color: var(--accent-secondary);
            background-color: var(--bg-primary);
            color: var(--accent-primary);
        }
        #data-panel .border-dashed label {
            color: var(--accent-primary);
        }
        #data-panel .border-dashed label i {
            color: var(--accent-primary);
        }
        #data-panel #fileNameDisplay, #data-panel #uploadStatus {
            color: var(--text-secondary);
        }
        #data-panel #uploadStatus.text-blue-400 {
            color: var(--accent-primary);
        }
        #data-panel #uploadStatus.text-green-500 {
            color: var(--accent-primary);
        }
        #data-panel #uploadStatus.text-red-500 {
            color: var(--accent-secondary);
        }

        #data-panel h3 {
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }
        #data-panel #schemaDisplay {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            border-color: var(--border-color);
            /* Engaging Empty State */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 250px; /* Ensure a minimum height */
            text-align: center;
        }
        #data-panel #schemaDisplay .placeholder-icon {
            font-size: 4rem; /* Large icon */
            color: var(--text-secondary); /* Subtle color */
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        #data-panel #schemaDisplay ul li {
            color: var(--text-secondary);
        }
        #data-panel #schemaDisplay ul li .font-bold {
            color: var(--accent-primary);
        }
        #data-panel #schemaDisplay ul li .font-medium {
            color: var(--accent-secondary);
        }


        /* Custom scrollbar for chat and results */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Animation for new messages */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-message {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Gradient for AI avatar */
        .ai-avatar-gradient {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        }

        /* Gradient for Send button and Download/Show Insights buttons */
        .send-button-gradient {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 0.6rem; /* Slightly less rounded than full circle */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            box-shadow: 0 4px 8px rgba(var(--accent-primary-rgb), 0.3); /* Lift effect */
        }
        .send-button-gradient:hover {
            transform: translateY(-2px); /* Further lift on hover */
            box-shadow: 0 6px 12px rgba(var(--accent-primary-rgb), 0.4);
        }
        .send-button-gradient:active {
            transform: translateY(0); /* Press down effect on click */
            box-shadow: 0 2px 4px rgba(var(--accent-primary-rgb), 0.2);
        }

        /* Code block styling - Now just for displaying JSON/raw data if needed, not explanations */
        .code-block {
            background-color: var(--code-bg);
            border-left: 4px solid var(--code-border);
            padding: 1rem;
            border-radius: 0.75rem;
            font-family: 'Roboto Mono', monospace;
            color: var(--code-text);
            white-space: pre-wrap;
            word-break: break-all;
            overflow-x: auto;
            max-height: 200px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        /* Input field focus glow */
        input:focus {
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.6);
            border-color: var(--accent-primary);
        }

        /* Chart Canvas Styling */
        .chart-container {
            position: relative; /* Needed for responsive canvas */
            height: 500px; /* Fixed height for consistent chart size */
            width: 100%; /* Take full width of its parent */
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color); /* Added border for visual separation */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Subtle shadow */
            margin: 1rem auto; /* Center with some margin */
        }
        .chart-container canvas {
            width: 100% !important; /* Important to override Chart.js inline sizing if any */
            height: 100% !important; /* Important to override Chart.js inline sizing if any */
            display: block; /* Remove extra space below canvas */
        }


        /* Table specific styles for the data preview */
        .data-table {
            color: var(--text-primary); /* Default text color for table content */
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: 600;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        /* Sort icon styling */
        .data-table th .sort-icon {
            color: var(--text-secondary);
            margin-left: 0.5rem;
            transition: color 0.2s ease-in-out;
        }
        .data-table th.sorted-asc .sort-icon,
        .data-table th.sorted-desc .sort-icon {
            color: var(--accent-primary);
        }

        /* Command Guide Specific Styles (Reverted to Table-like, but enhanced) */
        .command-guide-intro {
            color: var(--text-primary);
            margin-bottom: 2rem; /* More space below intro */
            font-size: 1.15rem; /* Slightly larger text */
            line-height: 1.6;
            text-align: center;
            font-weight: 500;
        }

        #commandGuideContent {
            display: flex; /* Use flex for a column layout of categories */
            flex-direction: column;
            gap: 1.5rem; /* Space between category sections */
            padding-bottom: 2rem;
        }

        .command-category-section {
            background-color: var(--bg-secondary); /* White background for category section */
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures rounded corners clip content */
        }

        .category-header-display {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.25rem 1rem; /* More vertical padding */
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); /* Blue gradient header */
            color: white; /* White text on blue gradient */
            font-size: 1.6rem; /* Slightly smaller for better fit */
            font-weight: 700;
            position: relative;
            z-index: 1; /* Ensure it's above content when scrolling */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Shadow for lift */
        }
        .category-header-display i {
            margin-right: 0.75rem;
            font-size: 1.8rem;
            color: white; /* Ensure icons are white */
        }

        .command-list-table {
            width: 100%;
            border-collapse: collapse; /* Collapse borders for clean lines */
        }

        .command-list-table th,
        .command-list-table td {
            padding: 1rem 1.25rem; /* Generous padding for content */
            text-align: left;
            border-bottom: 1px solid var(--border-color); /* Light separator */
            line-height: 1.4;
        }

        .command-list-table th {
            background-color: var(--table-header-bg); /* Light grey header */
            color: var(--table-header-text);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .command-list-table tbody tr {
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .command-list-table tbody tr:nth-child(odd) {
            background-color: var(--bg-secondary); /* White for odd rows */
        }
        .command-list-table tbody tr:nth-child(even) {
            background-color: var(--bg-primary); /* Very light grey for even rows */
        }
        .command-list-table tbody tr:hover {
            background-color: var(--table-row-hover); /* Light hover effect */
            transform: none; /* No lift on hover for table rows */
            box-shadow: none; /* No shadow on hover for table rows */
        }
        .command-list-table tbody tr:last-child td {
            border-bottom: none; /* No border on last row */
        }

        .command-list-table strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .command-list-table code {
            background-color: var(--code-bg); /* Very light grey for code background */
            color: var(--code-text); /* Dark text for code */
            padding: 0.2em 0.5em;
            border-radius: 0.3em;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85em;
            word-break: break-all;
            white-space: pre-wrap;
            border: 1px solid var(--border-color); /* Subtle border for code */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Very light inner shadow */
        }

        /* Added for click-to-paste feedback */
        .command-list-table tbody tr.feedback-highlight {
            background-color: rgba(74, 222, 128, 0.2) !important; /* Light green highlight */
            transition: background-color 0.1s ease-in-out;
        }

        .command-list-table td .feedback-icon {
            margin-left: 0.5rem;
            color: #10b981; /* Tailwind green-500 */
            font-size: 1.1em;
            vertical-align: middle;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .command-list-table td .feedback-icon.show {
            opacity: 1;
            transform: scale(1);
        }


        /* Search input specific styles for command guide */
        #commandSearchInput {
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
            padding-left: 2.75rem; /* Space for icon */
        }
        #commandSearchInput::placeholder {
            color: var(--text-secondary);
        }
        #commandSearchInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.6), inset 0 2px 4px rgba(0,0,0,0.3);
            outline: none;
        }
        /* Style for search input container and icon */
        .search-input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .search-input-container .fas.fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
            font-size: 1.1rem;
        }


        /* Styles for shrunk header */
        .header-shrunk {
            padding-top: 1rem !important;
            padding-bottom: 0.5rem !important;
        }
        .header-shrunk #mainTitle {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
        }
        .header-shrunk #subTitle {
            font-size: 0.875rem !important;
            margin-bottom: 0.25rem !important;
        }
        .header-shrunk #createdBy {
            font-size: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        .header-shrunk #toggleButtons {
            margin-bottom: 0rem !important;
            flex-wrap: wrap;
        }
        .header-shrunk #toggleButtons button {
            padding-top: 0.4rem !important;
            padding-bottom: 0.4rem !important;
            font-size: 0.8rem !important;
        }

        /* Proactive Insights Card Styling */
        .insight-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 15px var(--shadow-color);
            border-radius: 1.25rem; /* More rounded */
            padding: 1.5rem; /* More padding */
            transition: all 0.3s ease-in-out;
        }
        .insight-card:hover {
            box-shadow: 0 10px 20px var(--shadow-color);
            transform: translateY(-3px);
        }

        .insight-header {
            color: var(--accent-primary);
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .insight-header i {
            color: var(--accent-primary);
            margin-right: 0.75rem;
            font-size: 1.6rem;
        }
        .insight-message {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 1rem;
        }

        .insight-action {
            background-color: var(--accent-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s ease-in-out;
            margin-top: 1rem;
        }
        .insight-action:hover {
            background-color: var(--accent-secondary);
            box-shadow: 0 4px 8px rgba(var(--accent-primary-rgb), 0.4);
        }

        /* Collapsible content styles */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out; /* Slower transition */
        }

        .collapsible-content.show {
            max-height: 600px; /* Increased max-height for content */
            transition: max-height 0.5s ease-in;
        }

        /* Filter button styling */
        .filter-btn {
            background-color: var(--filter-inactive-bg);
            color: var(--filter-inactive-text);
            border-radius: 0.75rem;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .filter-btn:hover {
            background-color: var(--table-row-hover);
        }
        .filter-btn.active {
            background-color: var(--filter-active-bg);
            color: var(--filter-active-text);
            box-shadow: 0 4px 8px rgba(var(--accent-primary-rgb), 0.3);
        }

        /* Chat bubbles */
        #chatArea .flex.items-start > div:last-child { /* AI chat bubble */
            background-color: var(--chat-bubble-ai);
            color: var(--text-primary);
        }
        #chatArea .flex.justify-end > div:first-child { /* User chat bubble */
            background-color: var(--chat-bubble-user);
            color: var(--filter-active-text); /* White text on user bubble, usually */
        }

        /* Chat Input */
        #chatInput {
            border-color: var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        #chatInput::placeholder {
            color: var(--text-secondary);
        }
        #chatInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(var(--accent-primary-rgb), 0.6);
        }

        /* Overlays - Frosted Glass Effect */
        #commandGuideOverlay, #proactiveInsightsOverlay {
            background-color: rgba(var(--accent-primary-rgb), 0.1); /* Semi-transparent background using accent color */
            backdrop-filter: blur(15px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(15px); /* For Safari support */
            border: 1px solid rgba(var(--accent-primary-rgb), 0.2); /* Subtle border for effect */
            border-radius: 1.5rem; /* More rounded corners for the overlay itself */
            color: var(--text-primary);
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); /* Stronger shadow for depth */
            /* Added transition for smoother display */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        /* Ensure overlays are hidden correctly when not active */
        #commandGuideOverlay:not(.show), #proactiveInsightsOverlay:not(.show) {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #commandGuideOverlay.show, #proactiveInsightsOverlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }

        #commandGuideOverlay h3, #proactiveInsightsOverlay h3 {
            color: var(--accent-primary);
            font-size: 2.2rem;
            font-weight: 800;
        }
        #commandGuideOverlay h3 span, #proactiveInsightsOverlay h3 span {
            color: var(--text-primary);
        }
        #proactiveInsightsOverlay h3 i {
            color: var(--accent-primary);
        }

        /* Guided Tour Specific Styles (removed for this iteration) */
        /* All guided tour related elements and styles have been removed. */
        /* #tourOverlay, #tourModal, .tour-tooltip, .tour-highlight, etc. are no longer in use. */
    </style>
</head>
<body class="relative flex items-center justify-center h-screen w-screen">
    <!-- Background Bubbles Animation -->
    <div class="background-bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <div id="main-container" class="relative z-10 flex flex-col md:flex-row rounded-3xl shadow-2xl overflow-hidden w-full h-full transform transition-all duration-300">
        <!-- Left Pane: CSV Upload & Data Preview -->
        <div id="data-panel" class="p-8 flex-col shadow-inner-dark overflow-y-auto custom-scrollbar hidden md:w-0 md:hidden">
            <h2 class="text-4xl font-extrabold mb-2 text-center tracking-tight">CoDA <span class="font-extrabold">AI</span></h2>
            <p class="text-md mb-2 text-center italic">Your Strategic Data Copilot</p>
            <p class="text-sm mb-6 text-center">Created by: <span class="font-semibold">Utkarsh Kumar</span></p>

            <div id="csvUploadArea" class="mb-4 border-2 border-dashed rounded-2xl p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-600 transition duration-300 ease-in-out shadow-lg hover:shadow-xl">
                <label for="csvFileInput" class="cursor-pointer font-bold text-base flex flex-col items-center justify-center">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-2"></i>
                    <span class="block text-lg">Upload CSV File</span>
                    <span class="block text-xs mt-1">Click or drag & drop</span>
                </label>
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <p id="fileNameDisplay" class="mt-3 text-sm font-medium"></p>
                <p id="uploadStatus" class="mt-1 text-xs font-semibold"></p>
            </div>

            <!-- Download Button -->
            <button id="downloadCsvBtn" class="send-button-gradient p-3 rounded-2xl shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center space-x-2 mt-4 text-base font-bold">
                <i class="fas fa-download"></i>
                <span>Download Modified CSV</span>
            </button>

            <!-- Proactive Insights Button -->
            <button id="showProactiveInsightsBtn" class="send-button-gradient p-3 rounded-2xl shadow-lg focus:outline-none focus:ring-4 focus:ring-300 flex items-center justify-center space-x-2 mt-4 text-base font-bold">
                <i class="fas fa-lightbulb"></i>
                <span>Show Proactive Insights</span>
            </button>


            <h3 class="text-2xl font-bold mb-4 border-b pb-2 mt-8">Data Schema</h3>
            <div id="schemaDisplay" class="p-5 rounded-2xl flex-grow overflow-y-auto custom-scrollbar text-sm shadow-lg border min-h-[250px]">
                <i class="fas fa-file-csv placeholder-icon"></i> <!-- Engaging Empty State for Schema -->
                <p class="text-center py-4">Upload a CSV to intelligently infer and display its schema here.</p>
            </div>
        </div>

        <!-- Right Pane: Conversational Interface & Results -->
        <div id="chat-panel" class="w-full flex flex-col rounded-3xl">
            <div id="headerContainer" class="px-8 pt-6 pb-2 transition-all duration-500 ease-in-out">
                <h2 class="text-4xl font-extrabold mb-1 text-center tracking-tight" id="mainTitle">CoDA <span class="font-extrabold">AI</span></h2>
                <p class="text-md mb-1 text-center italic" id="subTitle">Your Strategic Data Copilot</p>
                <p class="text-sm mb-4 text-center" id="createdBy">Created by: <span class="font-semibold">Utkarsh Kumar</span></p>

                <!-- Toggle Buttons for Data Panel and Command Guide & Theme Selector -->
                <div class="flex justify-start space-x-3 mb-2" id="toggleButtons">
                    <button id="toggleDataPanelBtn" class="bg-gray-700 text-gray-200 px-4 py-2 rounded-full shadow-lg hover:bg-gray-600 transition duration-200 ease-in-out hidden md:flex items-center space-x-2">
                        <i class="fas fa-eye mr-2"></i> <span id="toggleButtonText">Show Data Panel</span>
                    </button>
                    <button id="toggleCommandGuideBtn" class="bg-gray-700 text-gray-200 px-4 py-2 rounded-full shadow-lg hover:bg-gray-600 transition duration-200 ease-in-out flex items-center space-x-2">
                        <i class="fas fa-book mr-2"></i> <span id="toggleCommandGuideText">Show Command Guide</span>
                    </button>
                    <div class="relative inline-block text-left ml-auto">
                        <select id="themeSelector" class="bg-gray-700 text-gray-200 px-4 py-2 rounded-full shadow-lg hover:bg-gray-600 transition duration-200 ease-in-out cursor-pointer appearance-none pr-8">
                            <option value="default">White & Blue</option> <!-- Changed default option text -->
                            <option value="cyberpunk">Cyberpunk</option>
                            <option value="forest">Forest</option>
                            <option value="ocean">Ocean</option>
                            <option value="sunset">Sunset</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-200">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chatArea" class="flex-grow px-6 py-6 rounded-2xl overflow-y-auto custom-scrollbar shadow-lg border mx-8">
                <!-- Initial AI message -->
                <div class="flex items-start mb-4 fade-in-message">
                    <div class="flex-shrink-0 w-10 h-10 ai-avatar-gradient rounded-full flex items-center justify-center text-white font-bold text-lg mr-4 shadow-md">AI</div>
                    <div class="p-4 rounded-3xl max-w-[80%] shadow-md transform hover:scale-[1.01] transition duration-200 ease-in-out">
                        <p class="leading-relaxed">Hello! Welcome to CoDA. Upload your CSV data to begin our private, client-side analysis. I'm ready to collaborate!</p>
                    </div>
                </div>
                <!-- AI Loading Indicator (hidden by default) -->
                <div id="aiLoadingIndicator" class="flex items-center justify-center mb-4 hidden">
                    <div class="flex-shrink-0 w-10 h-10 ai-avatar-gradient rounded-full flex items-center justify-center text-white font-bold text-lg mr-4 shadow-md">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="p-4 rounded-3xl max-w-[80%] shadow-md bg-gray-200 text-gray-700">
                        <p class="leading-relaxed">CoDA is thinking...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div id="chatInputArea" class="relative flex items-center space-x-3 px-8 pb-6 pt-4">
                <input type="text" id="chatInput" placeholder="Ask CoDA a question about your data, e.g., 'Show me the average sales'..." class="flex-grow p-4 border rounded-full focus:outline-none focus:ring-4 shadow-lg text-base transition duration-300 ease-in-out">
                <div id="suggestionsContainer" class="suggestions-container"></div>
                <button id="sendMessageBtn" class="send-button-gradient p-4 rounded-full shadow-lg focus:outline-none focus:ring-4">
                    <i class="fas fa-paper-plane text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Command Guide Overlay (Frosted Glass Effect) -->
    <div id="commandGuideOverlay" class="fixed inset-0 bg-opacity-95 p-8 flex flex-col rounded-3xl z-50 hidden overflow-y-auto custom-scrollbar">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-extrabold">CoDA AI Command Guide</h3>
            <button id="closeCommandGuideBtn" class="bg-gray-700 text-gray-200 px-4 py-2 rounded-full shadow-lg hover:bg-gray-600 transition duration-200 ease-in-out flex items-center space-x-2">
                <i class="fas fa-times mr-2"></i> <span>Close Guide</span>
            </button>
        </div>
        <!-- Search Input for Command Guide -->
        <div class="search-input-container">
            <i class="fas fa-search"></i>
            <input type="text" id="commandSearchInput" placeholder="Search commands..." class="mb-4">
        </div>

        <div id="commandGuideContent" class="flex-grow">
            <!-- Command guide content will be inserted here -->
        </div>
    </div>

    <!-- Proactive Insights Overlay (Frosted Glass Effect) -->
    <div id="proactiveInsightsOverlay" class="fixed inset-0 bg-opacity-95 p-8 flex flex-col rounded-3xl z-50 hidden overflow-y-auto custom-scrollbar">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-extrabold flex items-center">
                <i class="fas fa-brain mr-3 text-4xl"></i>
                <span>CoDA's <span>Proactive Insights</span></span>
            </h3>
            <button id="closeProactiveInsightsBtn" class="bg-gray-700 text-gray-200 px-4 py-2 rounded-full shadow-lg hover:bg-gray-600 transition duration-200 ease-in-out flex items-center space-x-2">
                <i class="fas fa-times mr-2"></i> <span>Close Insights</span>
            </button>
        </div>
        <!-- Search and Filter Controls -->
        <div class="mb-6 flex flex-wrap items-center gap-4">
            <input type="text" id="insightSearchInput" placeholder="Search insights..." class="flex-grow p-3 border rounded-xl focus:outline-none focus:ring-2 shadow-inner max-w-full md:max-w-xs">
            <div class="flex flex-wrap gap-2">
                <button class="filter-btn active px-4 py-2 rounded-xl text-sm font-semibold shadow-md transition-colors" data-filter="all">All</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold shadow-md transition-colors" data-filter="anomaly"><i class="fas fa-exclamation-triangle mr-2"></i>Anomaly</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold shadow-md transition-colors" data-filter="trend"><i class="fas fa-chart-line mr-2"></i>Trend</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold shadow-md transition-colors" data-filter="correlation"><i class="fas fa-link mr-2"></i>Correlation</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold shadow-md transition-colors" data-filter="distribution"><i class="fas fa-chart-pie mr-2"></i>Distribution</button>
            </div>
        </div>
        <div id="proactiveInsightsContent" class="flex-grow">
            <!-- Engaging Empty State for Proactive Insights -->
            <div class="flex flex-col items-center justify-center h-full text-center text-secondary opacity-70">
                <i class="fas fa-lightbulb placeholder-icon text-6xl mb-4"></i>
                <p class="text-center text-lg font-semibold">No proactive insights available yet.</p>
                <p class="text-center text-sm mt-2">Upload a CSV file to generate smart insights!</p>
            </div>
        </div>
    </div>


    <script>
        let rawData = [];
        let schema = {};
        let pendingCleaningSuggestion = null;
        let lastProactiveInsights = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Autocomplete elements
        const suggestionsContainer = document.getElementById('suggestionsContainer');

        // References to DOM elements
        const chatArea = document.getElementById('chatArea');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const uploadStatus = document.getElementById('uploadStatus');
        const schemaDisplay = document.getElementById('schemaDisplay');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const toggleDataPanelBtn = document.getElementById('toggleDataPanelBtn');
        const dataPanel = document.getElementById('data-panel');
        const chatPanel = document.getElementById('chat-panel');
        const toggleButtonText = document.getElementById('toggleButtonText');
        const toggleCommandGuideBtn = document.getElementById('toggleCommandGuideBtn');
        const commandGuideOverlay = document.getElementById('commandGuideOverlay');
        const commandGuideContent = document.getElementById('commandGuideContent');
        const commandSearchInput = document.getElementById('commandSearchInput');
        const closeCommandGuideBtn = document.getElementById('closeCommandGuideBtn');
        const toggleCommandGuideText = document.getElementById('toggleCommandGuideText');
        const headerContainer = document.getElementById('headerContainer');
        const showProactiveInsightsBtn = document.getElementById('showProactiveInsightsBtn');
        const proactiveInsightsOverlay = document.getElementById('proactiveInsightsOverlay');
        const proactiveInsightsContent = document.getElementById('proactiveInsightsContent');
        const closeProactiveInsightsBtn = document.getElementById('closeProactiveInsightsBtn');
        const insightSearchInput = document.getElementById('insightSearchInput');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const themeSelector = document.getElementById('themeSelector'); // New theme selector reference

        let isHeaderShrunk = false;

        // AI Loading Indicator Element
        const aiLoadingIndicator = document.getElementById('aiLoadingIndicator');


        // --- Theme Management ---
        const themes = {
            'default': { // New 'White and Blue' default theme
                '--bg-primary': '#f8fafc',
                '--bg-secondary': '#ffffff',
                '--text-primary': '#1a202c',
                '--text-secondary': '#4a5568',
                '--accent-primary': '#3b82f6',
                '--accent-secondary': '#2563eb',
                '--accent-primary-rgb': '59, 130, 246',
                '--border-color': '#e2e8f0',
                '--shadow-color': 'rgba(0, 0, 0, 0.1)',
                '--bubble-color': 'rgba(0, 0, 0, 0.02)',
                '--chat-bubble-ai': '#e2e8f0',
                '--chat-bubble-user': '#3b82f6',
                '--code-bg': '#f1f5f9',
                '--code-text': '#1a202c',
                '--code-border': '#3b82f6',
                '--table-header-bg': '#f0f4f8',
                '--table-header-text': '#2d3748',
                '--table-row-hover': '#e2e8f0',
                '--category-header-bg': 'rgba(59, 130, 246, 0.1)',
                '--category-header-text': '#1a202c',
                '--filter-active-bg': '#3b82f6',
                '--filter-active-text': '#ffffff',
                '--filter-inactive-bg': '#e2e8f0',
                '--filter-inactive-text': '#2d3748',
            },
            'cyberpunk': {
                '--bg-primary': '#0a0a0a',
                '--bg-secondary': '#1a0a2a',
                '--text-primary': '#00ffc0',
                '--text-secondary': '#ff00ff',
                '--accent-primary': '#00ffff',
                '--accent-secondary': '#ff00ff',
                '--accent-primary-rgb': '0, 255, 255',
                '--border-color': '#00ffff',
                '--shadow-color': 'rgba(0, 255, 255, 0.4)',
                '--bubble-color': 'rgba(0, 255, 255, 0.1)',
                '--chat-bubble-ai': '#2a003a',
                '--chat-bubble-user': '#00ffc0',
                '--code-bg': '#0d0d0d',
                '--code-text': '#00ffc0',
                '--code-border': '#00ffff',
                '--table-header-bg': '#1a0a2a',
                '--table-header-text': '#00ffff',
                '--table-row-hover': '#2a0a3a',
                '--category-header-bg': '#3a004a',
                '--category-header-text': '#ff00ff',
                '--filter-active-bg': '#00ffff',
                '--filter-active-text': '#0a0a0a',
                '--filter-inactive-bg': '#2a0a2a',
                '--filter-inactive-text': '#ff00ff',
            },
            'forest': {
                '--bg-primary': '#223c2d',
                '--bg-secondary': '#3a5a40',
                '--text-primary': '#d4e5d6',
                '--text-secondary': '#a8bfae',
                '--accent-primary': '#6a994e',
                '--accent-secondary': '#82b568',
                '--accent-primary-rgb': '106, 153, 78',
                '--border-color': '#5a826a',
                '--shadow-color': 'rgba(0, 0, 0, 0.3)',
                '--bubble-color': 'rgba(255, 255, 255, 0.03)',
                '--chat-bubble-ai': '#4a6a5a',
                '--chat-bubble-user': '#6a994e',
                '--code-bg': '#2e4a3a',
                '--code-text': '#d4e5d6',
                '--code-border': '#6a994e',
                '--table-header-bg': '#3a5a40',
                '--table-header-text': '#d4e5d6',
                '--table-row-hover': '#4a6a5a',
                '--category-header-bg': '#4a7a5a',
                '--category-header-text': '#e2e8f0',
                '--filter-active-bg': '#6a994e',
                '--filter-active-text': '#d4e5d6',
                '--filter-inactive-bg': '#4a6a5a',
                '--filter-inactive-text': '#e2e8f0',
            },
            'ocean': {
                '--bg-primary': '#0f1f3a',
                '--bg-secondary': '#1a3a5a',
                '--text-primary': '#e0f2f7',
                '--text-secondary': '#a7cadb',
                '--accent-primary': '#4a90e2',
                '--accent-secondary': '#2e78c8',
                '--accent-primary-rgb': '74, 144, 226',
                '--border-color': '#3a72b2',
                '--shadow-color': 'rgba(0, 0, 0, 0.3)',
                '--bubble-color': 'rgba(255, 255, 255, 0.04)',
                '--chat-bubble-ai': '#2a4a6a',
                '--chat-bubble-user': '#4a90e2',
                '--code-bg': '#1e2f4a',
                '--code-text': '#e0f2f7',
                '--code-border': '#4a90e2',
                '--table-header-bg': '#1a3a5a',
                '--table-header-text': '#e0f2f7',
                '--table-row-hover': '#2a4a6a',
                '--category-header-bg': '#3a5a7a',
                '--category-header-text': '#e0f2f7',
                '--filter-active-bg': '#4a90e2',
                '--filter-active-text': '#ffffff',
                '--filter-inactive-bg': '#2a4a6a',
                '--filter-inactive-text': '#e0f2f7',
            },
            'sunset': {
                '--bg-primary': '#3a1a0f',
                '--bg-secondary': '#5a2a1a',
                '--text-primary': '#fce3d7',
                '--text-secondary': '#d7b3a4',
                '--accent-primary': '#e05a30',
                '--accent-secondary': '#c44521',
                '--accent-primary-rgb': '224, 90, 48',
                '--border-color': '#a34a2e',
                '--shadow-color': 'rgba(0, 0, 0, 0.3)',
                '--bubble-color': 'rgba(255, 255, 255, 0.03)',
                '--chat-bubble-ai': '#4a2a1f',
                '--chat-bubble-user': '#e05a30',
                '--code-bg': '#3a2a1a',
                '--code-text': '#fce3d7',
                '--code-border': '#e05a30',
                '--table-header-bg': '#5a2a1a',
                '--table-header-text': '#fce3d7',
                '--table-row-hover': '#4a2a1f',
                '--category-header-bg': '#6a3a2a',
                '--category-header-text': '#fce3d7',
                '--filter-active-bg': '#e05a30',
                '--filter-active-text': '#fce3d7',
                '--filter-inactive-bg': '#4a2a1f',
                '--filter-inactive-text': '#fce3d7',
            }
        };

        function applyTheme(themeName) {
            const root = document.documentElement;
            const selectedTheme = themes[themeName] || themes['default'];

            for (const prop in selectedTheme) {
                root.style.setProperty(prop, selectedTheme[prop]);
            }
            localStorage.setItem('selectedTheme', themeName);
        }

        // Apply theme on load
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applyTheme(savedTheme);
            themeSelector.value = savedTheme; // Set dropdown to current theme
            
            // Guided tour removed, no longer start automatically
            // The logic for starting the guided tour on load is removed here.
        });

        // Event listener for theme selector
        themeSelector.addEventListener('change', (event) => {
            applyTheme(event.target.value);
        });

        // --- Guided Tour Functions (REMOVED) ---
        // All guided tour related elements (HTML div#tourOverlay, div#tourModal, div#tourTooltip)
        // and JavaScript functions (startGuidedTour, showTourModal, hideTourModal, showTourTooltip, hideTourTooltip, removeHighlight, nextTourStep, prevTourStep, tourSteps array and related event listeners)
        // have been entirely removed from the code for this version.

        // Function to parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== ''); // Filter out empty lines
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === headers.length) { // Ensure row has correct number of columns
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // Function to infer schema (basic type inference)
        function inferSchema(data) {
            if (data.length === 0) return {};
            const inferredSchema = {};
            const sampleRow = data[0];

            for (const key in sampleRow) {
                let type = 'string';
                // Very basic type inference: check if all values in column can be parsed as numbers
                const isNumeric = data.every(row => {
                    const value = row[key];
                    return value === '' || !isNaN(Number(value)); // Empty string or parseable as number
                });

                if (isNumeric) {
                    type = 'number';
                }
                inferredSchema[key] = type;
            }
            return inferredSchema;
        }

        // Function to display schema in the UI
        function displaySchema(schema) {
            schemaDisplay.innerHTML = '';
            if (Object.keys(schema).length === 0) {
                schemaDisplay.innerHTML = '<p class="text-center py-4">Upload a CSV to intelligently infer and display its schema here.</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'list-disc list-inside space-y-3';
            for (const key in schema) {
                const li = document.createElement('li');
                li.className = 'mb-1';
                li.innerHTML = `<span class="font-bold">${key}</span>: <span class="font-medium">${schema[key]}</span>`;
                ul.appendChild(li);
            }
            schemaDisplay.appendChild(ul);
        }

        // Helper function to calculate average of a numeric column
        function calculateColumnAverage(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length === 0) return 0;
            const sum = numericValues.reduce((acc, val) => acc + val, 0);
            return sum / numericValues.length;
        }

        // Helper function to calculate sum of a numeric column
        function calculateColumnSum(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length === 0) return 0;
            return numericValues.reduce((acc, val) => acc + val, 0);
        }

        // Helper function to find min/max of a numeric column
        function calculateColumnMinMax(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length === 0) return { min: null, max: null };
            return { min: Math.min(...numericValues), max: Math.max(...numericValues) };
        }

        // Helper to calculate median
        function calculateMedian(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n)).sort((a, b) => a - b);
            if (numericValues.length === 0) return null;
            const mid = Math.floor(numericValues.length / 2);
            return numericValues.length % 2 === 0 ? (numericValues[mid - 1] + numericValues[mid]) / 2 : numericValues[mid];
        }

        // Helper to calculate standard deviation
        function calculateStandardDeviation(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length < 2) return null;
            const mean = calculateColumnAverage(columnName, data);
            const sumOfSquares = numericValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);
            return Math.sqrt(sumOfSquares / (numericValues.length - 1));
        }

        // Helper to calculate quartiles (Q1, Median, Q3, IQR)
        function calculateQuartiles(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n)).sort((a, b) => a - b);
            if (numericValues.length === 0) return { q1: null, median: null, q3: null, iqr: null };

            const getMedian = arr => {
                const mid = Math.floor(arr.length / 2);
                return arr.length % 2 === 0 ? (arr[mid - 1] + arr[mid]) / 2 : arr[mid];
            };

            const median = getMedian(numericValues);
            const q1 = getMedian(numericValues.slice(0, Math.floor(numericValues.length / 2)));
            const q3 = getMedian(numericValues.slice(Math.ceil(numericValues.length / 2)));
            const iqr = q3 - q1;

            return { q1: q1.toFixed(2), median: median.toFixed(2), q3: q3.toFixed(2), iqr: iqr.toFixed(2) };
        }

        // Helper to calculate Pearson correlation coefficient
        function calculateCorrelation(col1, col2, data) {
            const validData = data.filter(row => !isNaN(Number(row[col1])) && !isNaN(Number(row[col2])));
            if (validData.length < 2) return null;

            const xValues = validData.map(row => Number(row[col1]));
            const yValues = validData.map(row => Number(row[col2]));

            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = yValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((sum, x, i) => sum + (x * yValues[i]), 0);
            const sumX2 = xValues.reduce((sum, x) => sum + (x * x), 0);
            const sumY2 = yValues.reduce((sum, y) => sum + (y * y), 0);

            const n = validData.length;

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            if (denominator === 0) return 0;
            return numerator / denominator;
        }

        // Helper to find outliers using IQR method
        function findOutliers(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n)).sort((a, b) => a - b);
            if (numericValues.length === 0) return { outliers: [], lowerBound: null, upperBound: null };

            const { q1, q3, iqr } = calculateQuartiles(columnName, data);
            if (q1 === null || q3 === null || iqr === null) return { outliers: [], lowerBound: null, upperBound: null };

            const lowerBound = parseFloat(q1) - 1.5 * parseFloat(iqr);
            const upperBound = parseFloat(q3) + 1.5 * parseFloat(iqr);

            const outliers = numericValues.filter(val => val < lowerBound || val > upperBound);

            return { outliers, lowerBound: lowerBound.toFixed(2), upperBound: upperBound.toFixed(2) };
        }

        // Helper to perform simple linear regression
        function performSimpleLinearRegression(xCol, yCol, data) {
            const validData = data.filter(row => !isNaN(Number(row[xCol])) && !isNaN(Number(row[yCol])));
            if (validData.length < 2) return null;

            const xValues = validData.map(row => Number(row[xCol]));
            const yValues = validData.map(row => Number(row[yCol]));

            const n = validData.length;
            const meanX = xValues.reduce((sum, x) => sum + x, 0) / n;
            const meanY = yValues.reduce((sum, y) => sum + y, 0) / n;

            let sumXY = 0;
            let sumX2 = 0;
            let sumY2 = 0;

            for (let i = 0; i < n; i++) {
                sumXY += (xValues[i] - meanX) * (yValues[i] - meanY);
                sumX2 += (xValues[i] - meanX) * (xValues[i] - meanX);
                sumY2 += (yValues[i] - meanY) * (yValues[i] - meanY);
            }

            const slope = sumX2 === 0 ? 0 : sumXY / sumX2;
            const intercept = meanY - slope * meanX;

            let ssResidual = 0;
            let ssTotal = 0;
            for (let i = 0; i < n; i++) {
                const yPredicted = slope * xValues[i] + intercept;
                ssResidual += Math.pow(yValues[i] - yPredicted, 2);
                ssTotal += Math.pow(yValues[i] - meanY, 2);
            }
            const rSquared = ssTotal === 0 ? 0 : (1 - (ssResidual / ssTotal));

            return { slope: slope.toFixed(4), intercept: intercept.toFixed(4), rSquared: rSquared.toFixed(4) };
        }

        // Helper for grouping and aggregating data for charts (e.g., for bar charts)
        function groupByAndAggregate(data, groupByColumn, aggregateColumn, aggregateType) {
            const groupedData = {};
            data.forEach(row => {
                const groupKey = row[groupByColumn];
                const value = Number(row[aggregateColumn]);

                if (groupKey !== undefined && groupKey !== null && groupKey !== '' && !isNaN(value)) { // Filter out invalid group keys or non-numeric values
                    if (!groupedData[groupKey]) {
                        groupedData[groupKey] = { sum: 0, count: 0 };
                    }
                    groupedData[groupKey].sum += value;
                    groupedData[key].count++;
                }
            });

            const labels = [];
            const values = [];

            // Sort labels alphabetically for consistent chart ordering
            const sortedGroupKeys = Object.keys(groupedData).sort();

            sortedGroupKeys.forEach(key => {
                labels.push(key);
                if (aggregateType === 'average') {
                    values.push(groupedData[key].sum / groupedData[key].count);
                } else {
                    values.push(groupedData[key].sum);
                }
            });
            return { labels, data: values };
        }

        // NEW HELPER: Get frequency distribution for a single categorical column
        function getFrequencyDistribution(columnName, data) {
            const values = data.map(row => row[columnName]).filter(v => v !== undefined && v !== null && v !== '');
            const valueCounts = {};
            values.forEach(v => { valueCounts[v] = (valueCounts[v] || 0) + 1; });

            const sortedEntries = Object.entries(valueCounts).sort(([,countA], [,countB]) => countB - countA);

            const labels = sortedEntries.map(entry => entry[0]);
            const counts = sortedEntries.map(entry => entry[1]);
            return { labels, data: counts };
        }


        // Advanced Feature: Check for missing values and suggest cleaning
        function checkAndSuggestDataCleaning(data, currentSchema) {
            let suggestions = [];
            for (const col in currentSchema) {
                if (currentSchema[col] === 'number') {
                    const missingCount = data.filter(row => row[col] === '' || row[col] === undefined || row[col] === null).length;
                    if (missingCount > 0) {
                        suggestions.push({
                            column: col,
                            type: 'missing_numeric',
                            count: missingCount,
                            action: 'fill_average'
                        });
                    }
                }
            }

            if (suggestions.length > 0) {
                const firstSuggestion = suggestions[0];
                pendingCleaningSuggestion = firstSuggestion;
                appendMessage('AI', `I noticed ${firstSuggestion.count} missing values in the numeric column "<strong>${firstSuggestion.column}</strong>". Would you like me to fill them with the column's average? (Type "yes" to confirm)`, 'ai');
            } else {
                pendingCleaningSuggestion = null;
            }
        }

        // --- Charting Functions ---

        // Helper to get consistent chart colors (using accent colors from theme)
        function getChartColors(count) {
            // These colors should ideally be dynamically pulled from theme accents or a more diverse palette
            // For now, using a blend of theme accents and a few more.
            const root = document.documentElement;
            const accentPrimary = getComputedStyle(root).getPropertyValue('--accent-primary').trim();
            const accentSecondary = getComputedStyle(root).getPropertyValue('--accent-secondary').trim();

            const baseColors = [
                accentPrimary,
                accentSecondary,
                'rgba(74, 222, 128, 0.8)', // Green
                'rgba(251, 191, 36, 0.8)', // Yellow
                'rgba(248, 113, 113, 0.8)', // Red
                'rgba(192, 132, 252, 0.8)', // Purple
                'rgba(129, 140, 248, 0.8)', // Indigo
                'rgba(244, 114, 182, 0.8)', // Pink
            ];
            return Array.from({ length: count }, (_, i) => baseColors[i % baseColors.length]);
        }

        // Function to create a chart (now with axis label options)
        function createChart(chartType, chartTitle, labels, data, xAxisLabelText = '', yAxisLabelText = '', options = {}) {
            const chartMessageDiv = document.createElement('div');
            chartMessageDiv.className = 'flex items-start mb-4 fade-in-message';
            chartMessageDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 ai-avatar-gradient rounded-full flex items-center justify-center text-white font-bold text-lg mr-4 shadow-md">AI</div>
                <div class="p-4 rounded-3xl max-w-[80%] shadow-md">
                    <p class="leading-relaxed">Here's the **${chartType} chart** for **${chartTitle}**:</p>
                </div>
            `;
            chatArea.appendChild(chartMessageDiv);

            const chartCanvas = document.createElement('canvas');
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.appendChild(chartCanvas);

            chatArea.appendChild(chartContainer);
            chatArea.scrollTop = chatArea.scrollHeight;

            let datasetsConfig = [];
            if (chartType === 'scatter') {
                datasetsConfig.push({
                    label: chartTitle,
                    data: data,
                    backgroundColor: getChartColors(1)[0],
                    borderColor: getChartColors(1)[0].replace('0.8', '1'),
                    pointRadius: 5,
                    pointHoverRadius: 7
                });
            } else {
                datasetsConfig.push({
                    label: chartTitle,
                    data: data,
                    backgroundColor: getChartColors(data.length),
                    borderColor: getChartColors(data.length).map(color => color.replace('0.8', '1')),
                    borderWidth: 1
                });
            }

            const ctx = chartCanvas.getContext('2d');
            const root = document.documentElement; // Get root element for CSS variables
            const textColor = getComputedStyle(root).getPropertyValue('--text-primary').trim();
            const tickColor = getComputedStyle(root).getPropertyValue('--text-secondary').trim();
            const gridColor = 'rgba(255,255,255,0.1)'; // Fixed subtle grid

            new Chart(ctx, {
                type: chartType,
                data: {
                    labels: (chartType !== 'scatter') ? labels : undefined,
                    datasets: datasetsConfig
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { // Added padding around the chart
                        padding: {
                            left: 20,
                            right: 20,
                            top: 20,
                            bottom: 20
                        }
                    },
                    plugins: {
                        legend: {
                            // Hide legend for single-dataset bar, pie, doughnut, polarArea charts
                            display: (datasetsConfig.length === 1 && (chartType === 'bar' || chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea')) ? false : true,
                            labels: {
                                color: textColor
                            }
                        },
                        title: {
                            display: true,
                            text: chartTitle,
                            color: textColor
                        }
                    },
                    scales: {
                        x: {
                            type: (chartType === 'scatter' || chartType === 'line') ? 'linear' : 'category',
                            ticks: {
                                color: tickColor
                            },
                            grid: {
                                color: gridColor
                            },
                            title: {
                                display: xAxisLabelText !== '',
                                text: xAxisLabelText,
                                color: textColor
                            }
                        },
                        y: {
                            type: 'linear',
                            ticks: {
                                color: tickColor
                            },
                            grid: {
                                color: gridColor
                            },
                            title: {
                                display: yAxisLabelText !== '',
                                text: yAxisLabelText,
                                color: textColor
                            }
                        }
                    },
                    ...options
                }
            });
        }

        // Function to get the HTML for the command list (now table-like)
        function getCommandListHtml(searchTerm = '') {
            const allCommands = [
                { category: 'General Overview', icon: 'fas fa-info-circle', commands: [
                    { sr: 1, command: 'Show all data', example: '<code>show all data</code>' },
                    { sr: 2, command: 'Show specific column data', example: '<code>show [column name]</code> (e.g., <code>show City</code>)' },
                    { sr: 3, command: 'Count rows', example: '<code>count rows</code>' },
                    { sr: 4, command: 'Describe dataset', example: '<code>describe my dataset</code>' },
                    { sr: 5, command: 'Show schema', example: '<code>show schema</code>' },
                ]},
                { category: 'Statistical Analysis', icon: 'fas fa-chart-bar', commands: [
                    { sr: 6, command: 'Sum a numeric column', example: '<code>sum [numeric column]</code> (e.g., <code>sum sales</code>)' },
                    { sr: 7, command: 'Average a numeric column', example: '<code>average [numeric column]</code> (e.g., <code>average age</code>)' },
                    { sr: 8, command: 'Median of a numeric column', example: '<code>median [numeric column]</code> (e.g., <code>median income</code>)' },
                    { sr: 9, command: 'Standard deviation of a numeric column', example: '<code>standard deviation [numeric column]</code> (e.g., <code>standard deviation price</code>)' },
                    { sr: 10, command: 'Quartiles of a numeric column', example: '<code>quartiles [numeric column]</code> (e.g., <code>quartiles score</code>)' },
                    { sr: 11, command: 'Count unique values in a column', example: '<code>count unique [column name]</code> (e.g., <code>count unique city</code>)' },
                    { sr: 12, command: 'Show frequency/top values', example: '<code>show frequency of [column name]</code> or <code>top values in [column name]</code> (e.g., <code>show frequency of product type</code>)' },
                    { sr: 13, command: 'Min/Max of a numeric column', example: '<code>min [numeric column]</code> or <code>max [numeric column]</code> (e.g., <code>min temperature</code>)' },
                    { sr: 14, command: 'Average a numeric column by categorical group', example: '<code>average [numeric column] by [categorical column]</code> (e.g., <code>average sales by region</code>)' },
                    { sr: 15, command: 'Correlation between two numeric columns', example: '<code>show correlation between [numeric_col1] and [numeric_col2]</code> (e.g., <code>show correlation between Age and Income</code>)' },
                    { sr: 16, command: 'Find outliers in a numeric column', example: '<code>find outliers in [numeric column]</code> (e.g., <code>find outliers in Sales</code>)' },
                ]},
                { category: 'Hypothesis Testing', icon: 'fas fa-flask', commands: [
                    { sr: 17, command: 'Perform T-test', example: '<code>perform t-test on [numeric_col] for [categorical_col] where [group1_value] vs [group2_value]</code> (e.g., <code>perform t-test on Sales for Region where East vs West</code>)' },
                    { sr: 18, command: 'Perform ANOVA', example: '<code>perform ANOVA on [numeric_col] by [categorical_col]</code> (e.g., <code>perform ANOVA on Sales by Region</code>)' },
                    { sr: 19, command: 'Perform Chi-Square Test', example: '<code>perform chi-square test on [categorical_col1] and [categorical_col2]</code> (e.g., <code>perform chi-square test on Gender and Purchase_Decision</code>)' },
                    { sr: 20, command: 'Perform Mann-Whitney U Test', example: '<code>perform Mann-Whitney U test on [numeric_col] for [categorical_col] where [group1_value] vs [group2_value]</code> (e.g., <code>perform Mann-Whitney U test on Income for Education where High School vs College</code>)' },
                ]},
                { category: 'Time Series Analysis', icon: 'fas fa-clock', commands: [
                    { sr: 21, command: 'Calculate Moving Average', example: '<code>calculate moving average of [numeric_col] with window [window_size] as [new_col_name]</code> (e.g., <code>calculate moving average of Stock_Price with window 5 as MA_5_Days</code>)' },
                ]},
                { category: 'Data Manipulation', icon: 'fas fa-cogs', commands: [
                    { sr: 22, command: 'Filter data', example: '<code>filter data where [column] [operator] [value]</code> (e.g., <code>sales > 1000</code> or <code>city = "London"</code>)' },
                    { sr: 23, command: 'Add a new calculated column', example: '<code>add column [new_name] as [col1] [operator] [col2]</code> (Operators: \'plus\', \'minus\', \'times\', \'divided by\'. E.g., <code>add column profit as revenue minus cost</code>)' },
                    { sr: 24, command: 'Categorize numeric data into bins', example: '<code>categorize [numeric_col] into [num_bins] bins as [new_col_name]</code> (e.g., <code>categorize Age into 5 bins as Age_Group</code>)' },
                    { sr: 25, command: 'Remove duplicate rows', example: '<code>remove duplicate rows</code>' },
                    { sr: 26, command: 'Rename column', example: '<code>rename column [old_name] to [new_name]</code> (e.g., <code>rename column Product_ID to SKU</code>)' },
                ]},
                { category: 'Business Intelligence', icon: 'fas fa-chart-line', commands: [
                    { sr: 27, command: 'Summarize numeric by categorical', example: '<code>summarize [numeric_col] by [categorical_col]</code> (e.g., <code>summarize Sales by Region</code>)' },
                    { sr: 28, command: 'Show overall business overview', example: '<code>show overall business overview</code>' },
                ]},
                { category: 'Data Export', icon: 'fas fa-file-export', commands: [
                    { sr: 29, command: 'Download modified dataset', example: 'Click the "Download Modified CSV" button' },
                ]},
                { category: 'Charting & Visualization', icon: 'fas fa-chart-pie', commands: [
                    { sr: 30, command: 'Show Bar Chart', example: '<code>show bar chart of [numeric_col] by [categorical_col] [as sum/average]</code> (e.g., <code>show bar chart of sales by region as average</code>)' },
                    { sr: 31, command: 'Show Line Chart', example: '<code>show line chart with X as [column] and Y as [numeric_column]</code> (e.g., <code>show line chart with X as Date and Y as Stock Price</code>)' },
                    { sr: 32, command: 'Show Scatter Plot', example: '<code>show scatter plot with X as [numeric_column1] and Y as [numeric_column2]</code> (e.g., <code>show scatter plot with X as Age and Y as Income</code>)' },
                    { sr: 33, command: 'Show Pie Chart', example: '<code>show pie chart of [column]</code> (e.g., <code>show pie chart of Gender</code>) or <code>show pie chart of [numeric_col] by [categorical_col] [as sum/average]</code>' },
                    { sr: 34, command: 'Show Doughnut Chart', example: '<code>show doughnut chart of [column]</code> (e.g., <code>show doughnut chart of Region</code>) or <code>show doughnut chart of [numeric_col] by [categorical_col] [as sum/average]</code>' },
                    { sr: 35, command: 'Show Polar Area Chart', example: '<code>show polar area chart of [column]</code> (e.g., <code>show polar area chart of Status</code>) or <code>show polar area chart of [numeric_col] by [categorical_col] [as sum/average]</code>' },
                ]},
                { category: 'Modeling', icon: 'fas fa-atom', commands: [
                    { sr: 36, command: 'Perform Simple Linear Regression', example: '<code>perform regression with Y as [numeric_col_y] and X as [numeric_col_x]</code> (e.g., <code>perform regression with Y as Sales and X as Advertising</code>)' },
                ]},
                { category: 'Advanced Modeling & Unsupervised Learning', icon: 'fas fa-brain', commands: [
                    { sr: 37, command: 'Perform Multiple Linear Regression', example: '<code>perform multiple regression with Y as [dep_var] and X as [indep_var1], [indep_var2], ...</code> (e.g., <code>perform multiple regression with Y as Sales and X as Advertising, Price</code>)' },
                    { sr: 38, command: 'Perform Polynomial Regression', example: '<code>perform polynomial regression with Y as [dep_var] and X as [indep_var] with degree [degree]</code> (e.g., <code>perform polynomial regression with Y as Sales and X as Advertising with degree 2</code>)' },
                    { sr: 39, command: 'Perform K-Means Clustering', example: '<code>perform k-means clustering on [col1], [col2], ... into [k] clusters as [new_cluster_column]</code> (e.g., <code>perform k-means clustering on Age, Income, Spending_Score into 3 clusters as Customer_Segment</code>)' },
                ]},
                { category: 'Data Transformation & Reshaping', icon: 'fas fa-table', commands: [
                    { sr: 40, command: 'Create Pivot Table', example: '<code>create pivot table with [row_col] as rows, [column_col] as columns, [value_col] as values aggregated by [sum/average/count]</code> (e.g., <code>create pivot table with Region as rows, Product_Category as columns, Sales as values aggregated by sum</code>)' },
                    { sr: 41, command: 'Unpivot/Melt Data', example: '<code>unpivot data keeping [id_col(s)] and melting [col1], [col2], ... into new variable [new_var_col] and value [new_val_col]</code> (e.g., <code>unpivot data keeping ID and melting Q1_Sales, Q2_Sales, Q3_Sales into new variable Quarter and value Sales_Amount</code>)' },
                ]},
                { category: 'Proactive Insights', icon: 'fas fa-lightbulb', commands: [
                    { sr: 42, command: 'Show Proactive Insights', example: '<code>show proactive insights</code> or <code>what insights do you have?</code>' },
                ]},
                { category: 'Reporting & Storytelling', icon: 'fas fa-file-alt', commands: [
                    { sr: 43, command: 'Generate Data Story / Create Report', example: '<code>generate data story</code> or <code>create report</code>' },
                ]},
            ];

            const lowerSearchTerm = searchTerm.toLowerCase();
            let contentHtml = `<p class="command-guide-intro">I'm ready to help with your data analysis! Here's a quick guide to what I can do:</p>`;

            let hasMatches = false;

            allCommands.forEach(cat => {
                const filteredCategoryCommands = cat.commands.filter(cmd =>
                    cmd.command.toLowerCase().includes(lowerSearchTerm) ||
                    cmd.example.toLowerCase().includes(lowerSearchTerm.replace(/`/g, '')) ||
                    cat.category.toLowerCase().includes(lowerSearchTerm) // Category itself matches search
                );

                if (filteredCategoryCommands.length > 0) {
                    hasMatches = true;
                    contentHtml += `
                        <div class="command-category-section">
                            <div class="category-header-display">
                                <i class="${cat.icon}"></i>
                                <span>${cat.category}</span>
                            </div>
                            <div class="command-list-wrapper">
                                <table class="command-list-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Sr. No.</th>
                                            <th style="width: 35%;">Command</th>
                                            <th style="width: 55%;">Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    filteredCategoryCommands.forEach(cmd => {
                        contentHtml += `
                            <tr onclick="typeIntoChatAndSubmit('${cmd.example.replace(/<\/?code>/g, '').replace(/'/g, "\\'")}', this)">
                                <td>${cmd.sr}</td>
                                <td><strong>${cmd.command}</strong></td>
                                <td>${cmd.example}<i class="fas fa-check-circle feedback-icon"></i></td>
                            </tr>
                        `;
                    });

                    contentHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>`; // Close command-category-section
                }
            });

            if (!hasMatches) {
                contentHtml = `<p class="command-guide-intro text-center py-8">No commands or categories match your search criteria.</p>`;
            }

            contentHtml += `<p class="mt-4 command-guide-intro">If I've made a cleaning suggestion, you can simply type <strong>'yes'</strong> to confirm.</p>`;

            return contentHtml;
        }

        /**
         * Generates an HTML table for displaying raw data with sortable headers.
         * @param {Array<Object>} data - The raw data to display.
         * @param {Object} schema - The schema of the data.
         * @param {string} sortCol - The current column being sorted.
         * @param {string} sortDir - The current sort direction ('asc' or 'desc').
         * @returns {string} HTML string of the data table.
         */
        function createDataTableHtml(data, schema, sortCol, sortDir) {
            if (data.length === 0 || Object.keys(schema).length === 0) {
                return '<p class="text-center py-4">No data available to display in a table. Please upload a CSV first!</p>';
            }

            const headers = Object.keys(schema);
            let tableHtml = `<div class="overflow-x-auto max-h-[400px] custom-scrollbar rounded-lg shadow-inner-dark border">
                                <table class="data-table">
                                    <thead>
                                        <tr>`;
            headers.forEach(header => {
                const isSorted = header === sortCol;
                const sortClass = isSorted ? `sorted-${sortDir}` : '';
                const sortIcon = isSorted ? (sortDir === 'asc' ? '<i class="fas fa-sort-up sort-icon"></i>' : '<i class="fas fa-sort-down sort-icon"></i>') : '<i class="fas fa-sort sort-icon"></i>';
                tableHtml += `<th class="${sortClass}" data-column-name="${header}">${header} ${sortIcon}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            const displayLimit = 200;
            const dataToDisplay = data.slice(0, displayLimit);

            dataToDisplay.forEach(row => {
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    const value = row[header] !== undefined && row[header] !== null ? row[header] : '';
                    tableHtml += `<td>${value}</td>`;
                });
                tableHtml += `</tr>`;
            });
            tableHtml += `</tbody></table></div>`;

            if (data.length > displayLimit) {
                tableHtml += `<p class="text-sm text-secondary mt-2">Displaying first ${displayLimit} of ${data.length} rows. Scroll to see more. Data is processed entirely on your device!</p>`;
            } else {
                tableHtml += `<p class="text-sm text-secondary mt-2">You have a total of ${data.length} rows. Data is processed entirely on your device!</p>`;
            }


            return tableHtml;
        }

        // --- Data Preview Table Sorting Logic ---
        function attachTableSortingListeners() {
            const dataTable = chatArea.querySelector('.data-table');
            if (!dataTable) return;

            const headers = dataTable.querySelectorAll('th[data-column-name]');
            headers.forEach(header => {
                header.addEventListener('click', (event) => {
                    const column = header.dataset.columnName;

                    if (column === currentSortColumn) {
                        currentSortDirection = (currentSortDirection === 'asc') ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortDirection = 'asc';
                    }

                    rawData.sort((a, b) => {
                        const valA = a[currentSortColumn];
                        const valB = b[currentSortColumn];

                        if (schema[currentSortColumn] === 'number') {
                            const numA = parseFloat(valA);
                            const numB = parseFloat(valB);
                            if (isNaN(numA) && isNaN(numB)) return 0;
                            if (isNaN(numA)) return currentSortDirection === 'asc' ? 1 : -1;
                            if (isNaN(numB)) return currentSortDirection === 'asc' ? -1 : 1;
                            return (currentSortDirection === 'asc' ? numA - numB : numB - numA);
                        } else {
                            const strA = String(valA).toLowerCase();
                            const strB = String(valB).toLowerCase();
                            if (strA < strB) return currentSortDirection === 'asc' ? -1 : 1;
                            if (strA > strB) return currentSortDirection === 'asc' ? 1 : -1;
                            return 0;
                        }
                    });

                    simulateAIResponse('show all data', true);

                });
            });
        }


        // Handle CSV file input change
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `File: ${file.name}`;
                uploadStatus.textContent = 'Loading and parsing...';
                uploadStatus.className = 'mt-1 text-xs font-semibold text-blue-400 animate-pulse';

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        rawData = parseCSV(e.target.result);
                        schema = inferSchema(rawData);
                        displaySchema(schema);
                        currentSortColumn = null;
                        currentSortDirection = 'asc';

                        uploadStatus.textContent = `Your ${file.name} has been uploaded successfully and is ready to perform analysis on.`;
                        uploadStatus.className = 'mt-1 text-xs font-semibold text-green-500';

                        checkAndSuggestDataCleaning(rawData, schema);
                        generateProactiveInsights();


                    } catch (error) {
                        uploadStatus.textContent = `Error parsing CSV: ${error.message}`;
                        uploadStatus.className = 'mt-1 text-xs font-semibold text-red-500';
                        appendMessage('AI', 'Oops! There was an error loading your CSV. Please ensure it\'s a valid CSV format with correct delimiters.', 'ai');
                    }
                };
                reader.readAsText(file);
            } else {
                fileNameDisplay.textContent = '';
                uploadStatus.textContent = 'No file selected.';
                uploadStatus.className = 'mt-1 text-xs font-semibold text-gray-400';
            }
        });

        // Function to append messages to the chat area
        function appendMessage(sender, text, type = 'user', skipScroll = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex mb-4 ${type === 'user' ? 'justify-end' : 'items-start'} fade-in-message`;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="p-4 rounded-3xl max-w-[80%] shadow-md transform hover:scale-[1.01] transition duration-200 ease-in-out">
                        <p class="leading-relaxed">${text}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 ai-avatar-gradient rounded-full flex items-center justify-center text-white font-bold text-lg mr-4 shadow-md">AI</div>
                    <div class="p-4 rounded-3xl max-w-[80%] shadow-md transform hover:scale-[1.01] transition duration-200 ease-in-out">
                        <p class="leading-relaxed">${text}</p>
                    </div>
                `;
            }
            chatArea.appendChild(messageDiv);
            if (!skipScroll) {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        // Helper to find a column by name (case-insensitive and partial match)
        function findColumnByName(rawName) {
            if (!rawName) return null;
            const lowerRawName = rawName.toLowerCase();
            for (const col in schema) {
                if (col.toLowerCase() === lowerRawName) {
                    return col;
                }
            }
            for (const col in schema) {
                if (col.toLowerCase().includes(lowerRawName)) {
                    return col;
                }
            }
            return null;
        }

        // Helper to find a numeric column by name
        function findNumericColumn(rawName) {
            const col = findColumnByName(rawName);
            if (col && schema[col] === 'number') {
                return col;
            }
            return null;
        }

        // Helper to find a categorical column by name
        function findCategoricalColumn(rawName) {
            const col = findColumnByName(rawName);
            if (col && schema[col] === 'string') {
                return col;
            }
            return null;
        }

        // Helper for basic descriptive statistics for a numeric column
        function getDescriptiveStats(columnName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length === 0) return null;

            const sum = numericValues.reduce((a, b) => a + b, 0);
            const mean = sum / numericValues.length;

            const sorted = [...numericValues].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            const median = sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];

            const min = Math.min(...numericValues);
            const max = Math.max(...numericValues);

            const sumOfSquares = numericValues.reduce((s, val) => s + Math.pow(val - mean, 2), 0);
            const variance = sumOfSquares / (numericValues.length - 1);
            const stdDev = Math.sqrt(variance);

            return {
                count: numericValues.length,
                mean: mean,
                median: median,
                min: min,
                max: max,
                stdDev: stdDev,
                sum: sum
            };
        }

        // New Feature: Categorize numeric column into bins
        function categorizeNumericColumn(columnName, numBins, newColName, data) {
            const numericValues = data.map(row => Number(row[columnName])).filter(n => !isNaN(n));
            if (numericValues.length === 0 || numBins <= 0) return { success: false, message: 'Invalid data or number of bins.' };

            const minVal = Math.min(...numericValues);
            const maxVal = Math.max(...numericValues);
            const binSize = (maxVal - minVal) / numBins;

            if (binSize === 0) {
                rawData = rawData.map(row => ({
                    ...row,
                    [newColName]: `${minVal.toFixed(2)} - ${maxVal.toFixed(2)}`
                }));
                schema[newColName] = 'string';
                displaySchema(schema);
                return { success: true, message: `All values in "${columnName}" are the same. Created a single bin for "${newColName}".` };
            }

            rawData = rawData.map(row => {
                const value = Number(row[columnName]);
                if (isNaN(value)) {
                    return { ...row, [newColName]: 'N/A' };
                }
                let binIndex = Math.floor((value - minVal) / binSize);
                if (binIndex === numBins) {
                    binIndex = numBins - 1;
                }

                const binStart = minVal + binIndex * binSize;
                const binEnd = minVal + (binIndex + 1) * binSize;
                return {
                    ...row,
                    [newColName]: `${binStart.toFixed(2)} - ${binEnd.toFixed(2)}`
                };
            });
            schema[newColName] = 'string';
            displaySchema(schema);
            return { success: true, message: `Categorized "<strong>${columnName}</strong>" into <strong>${numBins} bins</strong> and created a new column "<strong>${newColName}</strong>".` };
        }

        // New Feature: Remove duplicate rows
        function removeDuplicateRows(data) {
            const initialLength = data.length;
            const seen = new Set();
            const uniqueData = [];

            data.forEach(row => {
                const rowString = JSON.stringify(row);
                if (!seen.has(rowString)) {
                    seen.add(rowString);
                    uniqueData.push(row);
                }
            });
            rawData = uniqueData;
            const removedCount = initialLength - rawData.length;
            return { success: true, removedCount };
        }

        // New Feature: Rename column
        function renameColumn(oldName, newName) {
            const actualOldName = findColumnByName(oldName);
            if (!actualOldName) {
                return { success: false, message: `Column "<strong>${oldName}</strong>" not found.` };
            }
            if (Object.keys(schema).includes(newName)) {
                return { success: false, message: `Column "<strong>${newName}</strong>" already exists.` };
            }

            rawData = rawData.map(row => {
                const newRow = {};
                for (const key in row) {
                    if (key === actualOldName) {
                        newRow[newName] = row[key];
                    } else {
                        newRow[key] = row[key];
                    }
                }
                return newRow;
            });

            const newSchema = {};
            for (const key in schema) {
                if (key === actualOldName) {
                    newSchema[newName] = schema[key];
                } else {
                    newSchema[key] = schema[key];
                }
            }
            schema = newSchema;
            displaySchema(schema);
            return { success: true, message: `Column "<strong>${actualOldName}</strong>" successfully renamed to "<strong>${newName}</strong>".` };
        }

        // Function to download the current rawData as a CSV file
        function downloadCSV() {
            if (rawData.length === 0 || Object.keys(schema).length === 0) {
                appendMessage('AI', 'There is no data loaded to download. Please upload a CSV first!', 'ai');
                return;
            }

            const headers = Object.keys(schema);
            const csvRows = [];

            csvRows.push(headers.map(header => `"${header}"`).join(','));

            rawData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'CoDA_Modified_Data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            appendMessage('AI', 'Your modified dataset has been downloaded as **CoDA_Modified_Data.csv**!', 'ai');
        }

        downloadCsvBtn.addEventListener('click', downloadCSV);

        // --- Data Panel Toggle Logic ---
        dataPanel.classList.add('hidden', 'md:w-0', 'md:hidden');
        chatPanel.classList.remove('md:w-2/3');
        chatPanel.classList.add('md:w-full');
        toggleButtonText.textContent = 'Show Data Panel';
        toggleDataPanelBtn.querySelector('i').className = 'fas fa-eye mr-2';

        toggleDataPanelBtn.addEventListener('click', () => {
            const isCurrentlyHidden = dataPanel.classList.contains('hidden');

            if (isCurrentlyHidden) {
                dataPanel.classList.remove('hidden', 'md:w-0', 'md:hidden');
                dataPanel.classList.add('flex', 'md:w-1/3');
                chatPanel.classList.remove('md:w-full');
                chatPanel.classList.add('md:w-2/3');
                toggleButtonText.textContent = 'Hide Data Panel';
                toggleDataPanelBtn.querySelector('i').className = 'fas fa-eye-slash mr-2';
            } else {
                dataPanel.classList.remove('flex', 'md:w-1/3');
                dataPanel.classList.add('hidden', 'md:w-0', 'md:hidden');
                chatPanel.classList.remove('md:w-2/3');
                chatPanel.classList.add('md:w-full');
                toggleButtonText.textContent = 'Show Data Panel';
                toggleDataPanelBtn.querySelector('i').className = 'fas fa-eye mr-2';
            }
        });

        // Event listener for the toggle command guide button
        toggleCommandGuideBtn.addEventListener('click', () => {
            commandGuideOverlay.classList.remove('hidden');
            commandGuideContent.innerHTML = getCommandListHtml();
            toggleCommandGuideText.textContent = 'Hide Command Guide';
            toggleCommandGuideBtn.querySelector('i').className = 'fas fa-book-open mr-2';
            // Show the overlay explicitly with the .show class for transitions
            commandGuideOverlay.classList.add('show');
        });

        // Event listener for the close button INSIDE the overlay
        closeCommandGuideBtn.addEventListener('click', () => {
            // Hide the overlay explicitly by removing the .show class
            commandGuideOverlay.classList.remove('show');
            setTimeout(() => {
                commandGuideOverlay.classList.add('hidden'); // Fully hide after transition
            }, 300); // Match CSS transition duration
            toggleCommandGuideText.textContent = 'Show Command Guide';
            toggleCommandGuideBtn.querySelector('i').className = 'fas fa-book mr-2';
            commandSearchInput.value = '';
        });

        // Event listener for Command Guide Search Input
        commandSearchInput.addEventListener('input', () => {
            const searchTerm = commandSearchInput.value.trim();
            commandGuideContent.innerHTML = getCommandListHtml(searchTerm);
        });

        function parseDate(dateString) {
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? null : date;
            } catch (e) {
                console.warn(`Could not parse date string: ${dateString}`);
                return null;
            }
        }

        function getSumFromSubset(colName, dataSubset) {
            return dataSubset.reduce((acc, row) => {
                const val = Number(row[colName]);
                return acc + (isNaN(val) ? 0 : val);
            }, 0);
        }

        const ID_COLUMNS = ['id', 'row id', 'order id', 'customer id', 'product id', 'user id', 'transaction id'];

        function generateProactiveInsights() {
            if (rawData.length === 0) {
                lastProactiveInsights = [];
                return;
            }

            let insights = [];

            const dateCol = findColumnByName('Date') || findColumnByName('Order Date') || findColumnByName('Transaction Date');
            const salesCol = findNumericColumn('Sales') || findNumericColumn('Revenue') || findColumnByName('Amount');
            const regionCol = findCategoricalColumn('Region') || findCategoricalColumn('Area') || findCategoricalColumn('Territory');
            const marketingSpendCol = findNumericColumn('Marketing_Spend') || findNumericColumn('Ad_Spend') || findNumericColumn('Campaign_Cost');

            // Insight 1: Significant Sales Drop Detection (Time Series)
            if (dateCol && salesCol && regionCol) {
                const uniqueDates = [...new Set(rawData.map(row => row[dateCol]))]
                                        .map(parseDate)
                                        .filter(d => d !== null)
                                        .sort((a, b) => a.getTime() - b.getTime());

                if (uniqueDates.length >= 8) { // Need at least 8 days for 7-day average + current day
                    const latestDate = uniqueDates[uniqueDates.length - 1];
                    const eightDaysAgo = new Date(latestDate.getTime());
                    eightDaysAgo.setDate(latestDate.getDate() - 7);

                    const regions = [...new Set(rawData.map(row => row[regionCol]))].filter(r => r);

                    regions.forEach(region => {
                        const regionData = rawData.filter(row => row[regionCol] === region && parseDate(row[dateCol]) !== null);

                        const currentDaySalesData = regionData.filter(row => {
                            const date = parseDate(row[dateCol]);
                            return date && date.getDate() === latestDate.getDate() &&
                                       date.getMonth() === latestDate.getMonth() &&
                                       date.getFullYear() === latestDate.getFullYear();
                        });
                        const currentDaySales = getSumFromSubset(salesCol, currentDaySalesData);

                        const last7DaysSalesData = regionData.filter(row => {
                            const date = parseDate(row[dateCol]);
                            return date && date.getTime() >= eightDaysAgo.getTime() && date.getTime() < latestDate.getTime();
                        });
                        const last7DaysAvgSales = last7DaysSalesData.length > 0 ? getSumFromSubset(salesCol, last7DaysSalesData) / last7DaysSalesData.length : 0;

                        if (last7DaysAvgSales > 0) {
                            const salesDropPercentage = ((last7DaysAvgSales - currentDaySales) / last7DaysAvgSales) * 100;
                            const dropThreshold = 15; // Define a threshold for a "significant" drop

                            if (salesDropPercentage > dropThreshold) {
                                let messageToUser = `Sales in the **${region} region** are **down ${salesDropPercentage.toFixed(1)}%** on ${latestDate.toLocaleDateString()} compared to the last 7-day average. This deviation is significant.`;
                                let actionForUser = `filter data where ${regionCol} = '${region.replace(/'/g, "\\'")}' and ${dateCol} = '${latestDate.toLocaleDateString('en-US', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/'/g, "\\'")}'`;


                                if (marketingSpendCol) {
                                    const currentDayMarketingSpend = getSumFromSubset(marketingSpendCol, currentDaySalesData);
                                    const last7DaysMarketingSpend = last7DaysSalesData.length > 0 ? getSumFromSubset(marketingSpendCol, last7DaysSalesData) / last7DaysSalesData.length : 0;
                                    const marketingSpendDeviation = last7DaysMarketingSpend > 0 ? Math.abs((currentDayMarketingSpend - last7DaysMarketingSpend) / last7DaysMarketingSpend) * 100 : Infinity;
                                    const marketingConsistencyThreshold = 10;

                                    if (marketingSpendDeviation <= marketingConsistencyThreshold) {
                                        messageToUser += ` This is despite a **consistent marketing spend** in the region.`;
                                    } else {
                                        messageToUser += ` It also appears **marketing spend has changed** significantly in this period.`;
                                    }
                                }

                                insights.push({
                                    type: 'anomaly',
                                    icon: 'fas fa-chart-line-down',
                                    title: `Significant Sales Drop Detected in ${region} Region!`,
                                    message: messageToUser + `<br><br><strong>Recommendation:</strong>
                                        <ol>
                                            <li><strong>Investigate Sales Transactions:</strong> Examine specific sales transactions in ${region} for ${latestDate.toLocaleDateString()} to identify immediate patterns. Type: \`${actionForUser}\`</li>
                                            <li><strong>Review External Factors:</strong> This suggests external factors may be at play. Consider reviewing recent mobile app updates, website traffic analytics, or local events that might impact sales in the ${region} region.</li>
                                            <li><strong>Engage Relevant Teams:</strong> If external analysis points to a technical issue, consider alerting your mobile development or product team.</li>
                                        </ol>
                                        <em>(Note: CoDA is a client-side tool and cannot directly interact with external systems like email or Jira.)</em>`,
                                    action: actionForUser
                                });
                            }
                        }
                    });
                }
            }

            // Insight 2: Outlier Detection for Numeric Columns
            const numericCols = Object.keys(schema).filter(col => schema[col] === 'number');
            numericCols.forEach(col => {
                const { outliers, lowerBound, upperBound } = findOutliers(col, rawData);
                if (outliers.length > 0) {
                    insights.push({
                        type: 'anomaly',
                        icon: 'fas fa-exclamation-triangle',
                        title: `Outliers Detected in ${col} Column`,
                        message: `I've detected **${outliers.length} potential outliers** in the numeric column "<strong>${col}</strong>". These values fall outside the IQR bounds (${lowerBound} - ${upperBound}). This could indicate data entry errors or unusual events that warrant further investigation.`,
                        action: `find outliers in ${col}`
                    });
                }
            });

            // Insight 3: Top/Bottom Values by Categorical Groups (Relevant Numeric Columns Only)
            const categoricalCols = Object.keys(schema).filter(col => schema[col] === 'string');

            numericCols.forEach(numCol => {
                // Skip ID columns for 'top/bottom' aggregate insights
                if (ID_COLUMNS.includes(numCol.toLowerCase())) return;

                categoricalCols.forEach(catCol => {
                    // Skip if the categorical column is likely an ID, a date, or the same as the numeric column
                    if (ID_COLUMNS.some(id_col => catCol.toLowerCase().includes(id_col)) || catCol === dateCol || catCol === numCol) return;

                    const groupedData = {};
                    let hasValidDataForGrouping = false;

                    rawData.forEach(row => {
                        const category = row[catCol];
                        const numericValue = Number(row[numCol]);

                        if (category !== undefined && category !== null && category !== '' && !isNaN(numericValue)) { // Ensure category is valid and value is numeric
                            if (!groupedData[category]) {
                                groupedData[category] = { sum: 0, count: 0 };
                            }
                            groupedData[category].sum += numericValue;
                            groupedData[category].count++;
                            hasValidDataForGrouping = true;
                        }
                    });

                    if (!hasValidDataForGrouping || Object.keys(groupedData).length < 2) {
                        return; // Not enough valid groups or data points to form a meaningful insight
                    }


                    const sortedBySum = Object.entries(groupedData).sort(([, a], [, b]) => b.sum - a.sum);
                    const sortedByAvg = Object.entries(groupedData)
                                            .map(([category, data]) => [category, data.sum / data.count])
                                            .filter(([, avg]) => !isNaN(avg)) // Filter out NaN averages
                                            .sort(([, a], [, b]) => b - a);

                    if (sortedBySum.length > 1) { // Ensure at least two distinct groups for comparison
                        const topSumCat = sortedBySum[0];
                        const bottomSumCat = sortedBySum[sortedBySum.length - 1];
                        insights.push({
                            type: 'trend',
                            icon: 'fas fa-chart-line',
                            title: `Top/Bottom ${numCol} by ${catCol} (Total)`,
                            message: `For **total ${numCol}**, "<strong>${topSumCat[0]}</strong>" in **${catCol}** has the highest sum (${topSumCat[1].sum.toFixed(2)}), while "<strong>${bottomSumCat[0]}</strong>" has the lowest (${bottomSumCat[1].sum.toFixed(2)}). This highlights key areas of high and low aggregate performance.`,
                            action: `show bar chart of ${numCol} by ${catCol} as sum`
                        });
                    }

                    if (sortedByAvg.length > 1) { // Ensure at least two distinct groups for comparison
                        const topAvgCat = sortedByAvg[0];
                        const bottomAvgCat = sortedByAvg[sortedByAvg.length - 1];
                        insights.push({
                            type: 'trend',
                            icon: 'fas fa-chart-bar',
                            title: `Top/Bottom ${numCol} by ${catCol} (Average)`,
                            message: `For **average ${numCol}**, "<strong>${topAvgCat[0]}</strong>" in **${catCol}** shows the highest average (${topAvgCat[1].toFixed(2)}), whereas "<strong>${bottomAvgCat[0]}</strong>" has the lowest (${bottomAvgCat[1].toFixed(2)}). This reveals efficiency or intensity per category.`,
                            action: `show bar chart of ${numCol} by ${catCol} as average`
                        });
                    }
                });
            });

            // Insight 4: Strong Correlations between Numeric Columns
            const numericColumnNames = Object.keys(schema).filter(col => schema[col] === 'number' && !ID_COLUMNS.some(id_col => col.toLowerCase().includes(id_col))); // Exclude ID columns from correlation
            for (let i = 0; i < numericColumnNames.length; i++) {
                for (let j = i + 1; j < numericColumnNames.length; j++) {
                    const col1 = numericColumnNames[i];
                    const col2 = numericColumnNames[j];
                    const correlation = calculateCorrelation(col1, col2, rawData);
                    if (correlation !== null && !isNaN(correlation)) {
                        const absCorrelation = Math.abs(correlation);
                        let correlationStrength = '';
                        let interpretation = '';
                        if (absCorrelation >= 0.8) {
                            correlationStrength = 'a **very strong**';
                            interpretation = 'These columns move very closely together, indicating a strong direct or inverse relationship.';
                        } else if (absCorrelation >= 0.6) {
                            correlationStrength = 'a **strong**';
                            interpretation = 'A significant relationship exists, where changes in one column are consistently associated with changes in the other.';
                        } else if (absCorrelation >= 0.4) {
                            correlationStrength = 'a **moderate**';
                            interpretation = 'There is a noticeable relationship, but other factors might also be at play.';
                        } else if (absCorrelation >= 0.2) {
                            correlationStrength = 'a **weak**';
                            interpretation = 'A slight tendency for the columns to move together exists, but it is not a dominant relationship.';
                        }

                        if (correlationStrength) {
                            const direction = correlation > 0 ? 'positive' : 'negative';
                            insights.push({
                                type: 'correlation',
                                icon: 'fas fa-link',
                                title: `Correlation between ${col1} and ${col2}`,
                                message: `There's ${correlationStrength} ${direction} correlation (${correlation.toFixed(2)}) between "<strong>${col1}</strong>" and "<strong>${col2}</strong>". ${interpretation}`,
                                action: `show scatter plot with X as ${col1} and Y as ${col2}`
                            });
                        }
                    }
                }
            };

            // Insight 5: Distribution of Categorical Columns (excluding IDs)
            categoricalCols.forEach(catCol => {
                if (ID_COLUMNS.some(id_col => catCol.toLowerCase().includes(id_col)) || catCol === dateCol || catCol === regionCol) return; // Skip ID, date, and region as they might be covered by other insights

                const { labels, data: counts } = getFrequencyDistribution(catCol, rawData);
                if (labels.length > 0 && labels.length <= 10) { // Limit to columns with reasonable number of unique values for quick insights
                    let topValues = labels.slice(0, Math.min(3, labels.length)).map((item, i) => `"${item}" (${((counts[i]/rawData.length)*100).toFixed(1)}%)`).join(', ');
                    insights.push({
                        type: 'distribution',
                        icon: 'fas fa-chart-pie',
                        title: `Distribution of ${catCol}`,
                        message: `In "<strong>${catCol}</strong>", the top values are: ${topValues}. There are ${labels.length} unique values in total. Understanding these distributions is crucial for market segmentation or resource allocation.`,
                        action: `show frequency of ${catCol}`
                    });
                }
            });


            lastProactiveInsights = insights;
        }

        // Helper function to render insights based on current filters and search
        function renderProactiveInsights(filterType = 'all', searchTerm = '') {
            proactiveInsightsContent.innerHTML = '';

            if (lastProactiveInsights.length === 0) {
                proactiveInsightsContent.innerHTML = '<p class="text-center py-4">No proactive insights available yet. Upload a CSV file to generate proactive insights.</p>';
                return;
            }

            let filteredInsights = lastProactiveInsights.filter(insight => {
                const matchesFilter = filterType === 'all' || insight.type === filterType;
                const matchesSearch = searchTerm === '' ||
                                            insight.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                            insight.message.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                            insight.action.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesFilter && matchesSearch;
            });

            if (filteredInsights.length === 0) {
                proactiveInsightsContent.innerHTML = `<p class="text-center py-4">No insights match your current filters and search criteria.</p>`;
                return;
            }

            filteredInsights.forEach((insight, index) => {
                const insightCard = document.createElement('div');
                insightCard.className = 'insight-card';
                insightCard.innerHTML = `
                    <div class="insight-header cursor-pointer" data-insight-index="${index}">
                        <i class="mr-2 ${insight.icon}"></i>
                        <h4>${insight.title}</h4>
                        <i class="fas fa-chevron-down ml-auto transition-transform"></i>
                    </div>
                    <div class="collapsible-content">
                        <p class="insight-message">${insight.message}</p>
                        ${insight.action ? `<span class="text-sm italic">Suggested Command: </span><a href="#" class="insight-action" onclick="typeIntoChatAndSubmit('${insight.action.replace(/'/g, "\\'")}'); return false;">'${insight.action}'</a>` : ''}
                    </div>
                `;
                proactiveInsightsContent.appendChild(insightCard);
            });

            document.querySelectorAll('.insight-header').forEach(header => {
                header.addEventListener('click', (event) => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.fa-chevron-down');

                    if (content.classList.contains('show')) {
                        content.classList.remove('show');
                        icon.classList.remove('rotate-180');
                    } else {
                        document.querySelectorAll('.collapsible-content.show').forEach(openContent => {
                            openContent.classList.remove('show');
                            openContent.previousElementSibling.querySelector('.fa-chevron-down').classList.remove('rotate-180');
                        });
                        content.classList.add('show');
                        icon.classList.add('rotate-180');
                    }
                });
            });
        }

        /**
         * Performs a Welch's t-test to compare means of two independent groups.
         * @param {string} numericColName - The name of the numeric column.
         * @param {string} categoricalColName - The name of the categorical column defining groups.
         * @param {string} group1Value - The value in the categorical column for group 1.
         * @param {string} group2Value - The value in the categorical column for group 2.
         * @param {Array<Object>} data - The dataset.
         * @returns {Object} An object containing t-statistic, degrees of freedom, and interpretation.
         */
        function performTTest(numericColName, categoricalColName, group1Value, group2Value, data) {
            const numericCol = findNumericColumn(numericColName);
            const categoricalCol = findCategoricalColumn(categoricalColName);

            if (!numericCol || !categoricalCol) {
                return { error: 'Both numeric and categorical columns must be valid for the T-test.' };
            }

            const group1Data = data.filter(row => row[categoricalCol] === group1Value).map(row => Number(row[numericCol])).filter(n => !isNaN(n));
            const group2Data = data.filter(row => row[categoricalCol] === group2Value).map(row => Number(row[numericCol])).filter(n => !isNaN(n));

            if (group1Data.length < 2 || group2Data.length < 2) {
                return { error: `Not enough data points for both groups (minimum 2 per group required). Group 1 has ${group1Data.length}, Group 2 has ${group2Data.length}.` };
            }

            const n1 = group1Data.length;
            const n2 = group2Data.length;
            const mean1 = group1Data.reduce((a, b) => a + b, 0) / n1;
            const mean2 = group2Data.reduce((a, b) => a + b, 0) / n2;

            const variance1 = group1Data.reduce((sum, val) => sum + Math.pow(val - mean1, 2), 0) / (n1 - 1);
            const variance2 = group2Data.reduce((sum, val) => sum + Math.pow(val - mean2, 2), 0) / (n2 - 1);

            const numerator = mean1 - mean2;
            const denominator = Math.sqrt((variance1 / n1) + (variance2 / n2));

            if (denominator === 0) {
                return { error: 'Denominator is zero, likely due to zero variance in one or both groups. Cannot perform t-test.' };
            }

            const tStatistic = numerator / denominator;

            const dfNumerator = Math.pow((variance1 / n1) + (variance2 / n2), 2);
            const dfDenominator = (Math.pow(variance1 / n1, 2) / (n1 - 1)) + (Math.pow(variance2 / n2, 2) / (n2 - 1));
            const degreesOfFreedom = dfDenominator === 0 ? Math.min(n1, n2) - 1 : dfNumerator / dfDenominator;

            let interpretation = '';
            // Basic interpretation using a common alpha level (e.g., 0.05)
            // For a more accurate interpretation, one would need a t-distribution table or a p-value function.
            // Critical t-values at alpha=0.05 (two-tailed) for various dfs:
            // df=1 -> 12.71, df=2 -> 4.30, df=5 -> 2.57, df=10 -> 2.23, df=30 -> 2.04, df=inf -> 1.96
            if (Math.abs(tStatistic) > 2) { // Using 2 as a rough threshold for significance for many degrees of freedom
                interpretation = `This suggests a statistically **significant difference** between the means of "${group1Value}" and "${group2Value}" for "${numericColName}".`;
            } else {
                interpretation = `There is **no strong evidence of a statistically significant difference** between the means of "${group1Value}" and "${group2Value}" for "${numericColName}".`;
            }

            return {
                tStatistic: tStatistic.toFixed(3),
                degreesOfFreedom: degreesOfFreedom.toFixed(2),
                interpretation: interpretation,
                group1Mean: mean1.toFixed(2),
                group2Mean: mean2.toFixed(2),
                group1Count: n1,
                group2Count: n2
            };
        }

        /**
         * Performs a one-way ANOVA to compare means across three or more groups.
         * @param {string} numericColName - The name of the numeric column.
         * @param {string} categoricalColName - The name of the categorical column defining groups.
         * @param {Array<Object>} data - The dataset.
         * @returns {Object} An object containing F-statistic, degrees of freedom, and interpretation.
         */
        function performANOVA(numericColName, categoricalColName, data) {
            const numericCol = findNumericColumn(numericColName);
            const categoricalCol = findCategoricalColumn(categoricalColName);

            if (!numericCol || !categoricalCol) {
                return { error: 'Both numeric and categorical columns must be valid for ANOVA.' };
            }

            const groups = {};
            data.forEach(row => {
                const category = row[categoricalCol];
                const value = Number(row[numericCol]);
                if (category !== undefined && category !== null && category !== '' && !isNaN(value)) {
                    if (!groups[category]) {
                        groups[category] = [];
                    }
                    groups[category].push(value);
                }
            });

            const groupNames = Object.keys(groups).filter(name => groups[name].length > 1); // Need at least 2 data points per group for a valid group
            if (groupNames.length < 2) {
                return { error: 'Need at least two groups with more than one data point each to perform ANOVA.' };
            }

            // Calculate overall mean
            const allValues = [];
            groupNames.forEach(name => allValues.push(...groups[name]));
            if (allValues.length === 0) {
                return { error: 'No valid data points found for ANOVA.' };
            }
            const overallMean = allValues.reduce((sum, val) => sum + val, 0) / allValues.length;

            let SSBetween = 0; // Sum of Squares Between Groups
            let SSWithin = 0;  // Sum of Squares Within Groups

            groupNames.forEach(name => {
                const groupData = groups[name];
                const groupMean = groupData.reduce((sum, val) => sum + val, 0) / groupData.length;

                SSBetween += groupData.length * Math.pow(groupMean - overallMean, 2);
                groupData.forEach(val => {
                    SSWithin += Math.pow(val - groupMean, 2);
                });
            });

            const dfBetween = groupNames.length - 1;
            const dfWithin = allValues.length - groupNames.length;

            if (dfWithin <= 0 || dfBetween <= 0) {
                return { error: `Not enough degrees of freedom to perform ANOVA. df_between=${dfBetween}, df_within=${dfWithin}. Ensure enough data points per group (min 2 per group) and at least two groups.` };
            }

            const MSBetween = SSBetween / dfBetween;
            const MSWithin = SSWithin / dfWithin;

            const fStatistic = MSWithin === 0 ? Infinity : MSBetween / MSWithin; // Handle case where within-group variance is zero

            let interpretation = '';
            // Rough interpretation based on F-statistic. Needs F-distribution table for exact p-value.
            // Using a common critical F-value of ~3-5 for significance for many typical scenarios (alpha=0.05)
            if (fStatistic > 3) { // This is a very rough estimate; actual critical F depends on df1, df2
                interpretation = `This suggests a statistically **significant difference** between the means of at least two groups for "${numericColName}" based on "${categoricalColName}".`;
            } else {
                interpretation = `There is **no strong evidence of a statistically significant difference** between the means of the groups for "${numericColName}" based on "${categoricalColName}".`;
            }

            return {
                fStatistic: fStatistic.toFixed(3),
                dfBetween: dfBetween,
                dfWithin: dfWithin,
                interpretation: interpretation,
                groupsAnalyzed: groupNames.length
            };
        }


        /**
         * Performs a Chi-Square Test of Independence on two categorical variables.
         * @param {string} col1Name - Name of the first categorical column.
         * @param {string} col2Name - Name of the second categorical column.
         * @param {Array<Object>} data - The dataset.
         * @returns {Object} An object containing Chi-Square statistic, degrees of freedom, and interpretation.
         */
        function performChiSquareTest(col1Name, col2Name, data) {
            const catCol1 = findCategoricalColumn(col1Name);
            const catCol2 = findCategoricalColumn(col2Name);

            if (!catCol1 || !catCol2) {
                return { error: 'Both columns must be valid categorical columns for the Chi-Square test.' };
            }

            // Build contingency table
            const contingencyTable = {};
            const rowTotals = {};
            const colTotals = {};
            let grandTotal = 0;

            data.forEach(row => {
                const val1 = row[catCol1];
                const val2 = row[catCol2];

                if (val1 === undefined || val2 === undefined || val1 === null || val2 === null || val1 === '' || val2 === '') {
                    return; // Skip rows with missing or empty values for analysis
                }

                if (!contingencyTable[val1]) {
                    contingencyTable[val1] = {};
                }
                contingencyTable[val1][val2] = (contingencyTable[val1][val2] || 0) + 1;

                rowTotals[val1] = (rowTotals[val1] || 0) + 1;
                colTotals[val2] = (colTotals[val2] || 0) + 1;
                grandTotal++;
            });

            const rowCategories = Object.keys(contingencyTable);
            const colCategories = Object.keys(colTotals);

            if (rowCategories.length < 2 || colCategories.length < 2) {
                return { error: `Each categorical column must have at least two unique, non-empty categories for the Chi-Square test. Found ${rowCategories.length} unique for "${catCol1}" and ${colCategories.length} for "${catCol2}".` };
            }

            let chiSquareStatistic = 0;
            rowCategories.forEach(rCat => {
                colCategories.forEach(cCat => {
                    const observed = contingencyTable[rCat][cCat] || 0;
                    const expected = (rowTotals[rCat] * colTotals[cCat]) / grandTotal;

                    if (expected > 0) { // Avoid division by zero
                        chiSquareStatistic += Math.pow(observed - expected, 2) / expected;
                    }
                });
            });

            const df = (rowCategories.length - 1) * (colCategories.length - 1);

            if (df <= 0) {
                 return { error: `Degrees of freedom for Chi-Square test is zero or negative (df=${df}). This usually happens if a column has only one category after filtering or missing data, or if there's no variability.` };
            }

            let interpretation = '';
            // Critical Chi-Square values (alpha=0.05):
            // df=1 -> 3.84, df=2 -> 5.99, df=3 -> 7.81, df=4 -> 9.49
            const criticalValue = 3.84; // Using a common critical value for df=1 (most common case for 2x2 table)
                                        // For a more general case, a chi-square distribution table would be needed.
            if (chiSquareStatistic > criticalValue) {
                interpretation = `This suggests a statistically **significant association** between "<strong>${catCol1}</strong>" and "<strong>${catCol2}</strong>". The two categorical variables are likely **dependent**.`;
            } else {
                interpretation = `There is **no strong evidence of a statistically significant association** between "<strong>${catCol1}</strong>" and "<strong>${catCol2}</strong>". The two categorical variables appear to be **independent**.`;
            }

            return {
                chiSquareStatistic: chiSquareStatistic.toFixed(3),
                degreesOfFreedom: df,
                interpretation: interpretation,
                tablePreview: JSON.stringify(contingencyTable, null, 2)
            };
        }

        /**
         * Performs a Mann-Whitney U Test (also known as Wilcoxon Rank-Sum Test) for two independent samples.
         * This test is a non-parametric alternative to the independent samples t-test.
         * It assumes that the samples are independent and that the data is at least ordinal.
         * @param {string} numericColName - The name of the numeric column to test.
         * @param {string} categoricalColName - The name of the categorical column defining two groups.
         * @param {string} group1Value - The value for the first group in the categorical column.
         * @param {string} group2Value - The value for the second group in the categorical column.
         * @param {Array<Object>} data - The dataset.
         * @returns {Object} An object containing U-statistic, interpretation, and group sizes.
         */
        function performMannWhitneyU(numericColName, categoricalColName, group1Value, group2Value, data) {
            const numericCol = findNumericColumn(numericColName);
            const categoricalCol = findCategoricalColumn(categoricalColName);

            if (!numericCol || !categoricalCol) {
                return { error: 'Both numeric and categorical columns must be valid for the Mann-Whitney U test.' };
            }

            const group1Data = data.filter(row => row[categoricalCol] === group1Value).map(row => Number(row[numericCol])).filter(n => !isNaN(n));
            const group2Data = data.filter(row => row[categoricalCol] === group2Value).map(row => Number(row[numericCol])).filter(n => !isNaN(n));

            if (group1Data.length < 5 || group2Data.length < 5) { // Mann-Whitney U is more reliable with larger samples
                return { error: `Not enough data points for both groups (minimum 5 per group recommended). Group 1 has ${group1Data.length}, Group 2 has ${group2Data.length}.` };
            }

            const n1 = group1Data.length;
            const n2 = group2Data.length;

            // Combine and rank all data points
            const combined = [...group1Data.map(val => ({ val, group: 1 })), ...group2Data.map(val => ({ val, group: 2 }))];
            combined.sort((a, b) => a.val - b.val);

            // Assign ranks, handling ties by averaging ranks
            for (let i = 0; i < combined.length; i++) {
                let j = i;
                while (j < combined.length - 1 && combined[j].val === combined[j + 1].val) {
                    j++;
                }
                const tieSize = j - i + 1;
                const averageRank = (i + 1 + j + 1) / 2;
                for (let k = i; k <= j; k++) {
                    combined[k].rank = averageRank;
                }
                i = j;
            }

            // Sum ranks for each group
            const R1 = combined.filter(d => d.group === 1).reduce((sum, d) => sum + d.rank, 0);
            const R2 = combined.filter(d => d.group === 2).reduce((sum, d) => sum + d.rank, 0);

            // Calculate U statistics
            const U1 = R1 - (n1 * (n1 + 1)) / 2;
            const U2 = R2 - (n2 * (n2 + 1)) / 2;

            const U = Math.min(U1, U2);

            let interpretation = '';
            // For large samples (n > ~20), U is approximately normally distributed.
            // For smaller samples, critical tables are needed.
            // For simplicity in a prototype, we'll use a very general interpretation.
            // A smaller U value (relative to sample sizes) indicates a greater difference.
            // A more formal calculation would involve mean and std dev of U under null hypothesis and then a z-score.

            // As a very rough guideline, if U is very small compared to n1*n2 / 2, it indicates a difference.
            const expectedUUnderNull = (n1 * n2) / 2;
            const thresholdRatio = 0.3; // If U is less than 30% of expectedU, consider it "potentially significant"
                                        // This is purely for demonstration and not statistically rigorous for all cases.

            if (U < expectedUUnderNull * thresholdRatio) {
                interpretation = `The Mann-Whitney U test suggests that there is a **statistically significant difference** between the distributions of "${numericCol}" for "${group1Value}" and "${group2Value}". One group tends to have ranks higher than the other.`;
            } else {
                interpretation = `The Mann-Whitney U test suggests **no strong evidence of a statistically significant difference** between the distributions of "${numericCol}" for "${group1Value}" and "${group2Value}". The distributions appear similar.`;
            }

            return {
                uStatistic: U.toFixed(2),
                group1Count: n1,
                group2Count: n2,
                interpretation: interpretation
            };
        }

        // Modified typeIntoChatAndSubmit to accept a clicked element for visual feedback
        function typeIntoChatAndSubmit(command, clickedElement = null) {
            chatInput.value = command;
            
            if (clickedElement) {
                const feedbackIcon = clickedElement.querySelector('.feedback-icon');
                if (feedbackIcon) {
                    clickedElement.classList.add('feedback-highlight');
                    feedbackIcon.classList.add('show');
                    setTimeout(() => {
                        clickedElement.classList.remove('feedback-highlight');
                        feedbackIcon.classList.remove('show');
                    }, 1000); // Highlight for 1 second
                }
            }
            sendMessageBtn.click();
            proactiveInsightsOverlay.classList.add('hidden');
        }


        function simulateAIResponse(query, isResort = false) {
            let aiResponseText = '';
            let analysisContent = '';
            const lowerQuery = query.toLowerCase();

            if (isResort && (lowerQuery.includes('show all data') || lowerQuery.includes('display everything') || lowerQuery.includes('what\'s in the dataset'))) {
                const aiMessages = chatArea.querySelectorAll('.flex.items-start');
                aiMessages.forEach(msg => {
                    if (msg.nextElementSibling && msg.nextElementSibling.querySelector('.data-table')) {
                         msg.remove();
                         msg.nextElementSibling.remove();
                    }
                });
                appendMessage('AI', `Here's your data, sorted by "<strong>${currentSortColumn}</strong>" in ${currentSortDirection === 'asc' ? 'ascending' : 'descending'} order:`, 'ai', true);
                analysisContent = createDataTableHtml(rawData, schema, currentSortColumn, currentSortDirection);
                appendMessage('AI', analysisContent, 'ai');
                attachTableSortingListeners();
                return;
            }


            if (rawData.length === 0 && !lowerQuery.includes('command guide') && !lowerQuery.includes('data story') && !lowerQuery.includes('create report')) {
                appendMessage('AI', "Please upload a CSV file first before asking questions. I'm ready when you are!", 'ai');
                return;
            }

            if (pendingCleaningSuggestion && (lowerQuery === 'yes' || lowerQuery.includes('confirm') || lowerQuery.includes('go ahead'))) {
                const colToClean = pendingCleaningSuggestion.column;
                if (pendingCleaningSuggestion.action === 'fill_average') {
                    const average = calculateColumnAverage(colToClean, rawData);
                    rawData = rawData.map(row => {
                        if (row[colToClean] === '' || isNaN(Number(row[colToClean])) || row[colToClean] === null || row[colToClean] === undefined) {
                            row[colToClean] = average.toFixed(2);
                        }
                        return row;
                    });
                    aiResponseText = `Great! I've successfully filled the ${pendingCleaningSuggestion.count} missing values in the column "<strong>${colToClean}</strong>" with the calculated average of <strong>${average.toFixed(2)}</strong>. Your data has been updated locally and privately.`;
                    pendingCleaningSuggestion = null;
                }
                appendMessage('AI', aiResponseText, 'ai');
                return;
            }

            if (lowerQuery.includes('show all data') || lowerQuery.includes('display everything') || lowerQuery.includes('what\'s in the dataset')) {
                analysisContent = createDataTableHtml(rawData, schema, currentSortColumn, currentSortDirection);
                aiResponseText = `Understood! Here's your data:`;
            } else if (lowerQuery.startsWith('show ') && lowerQuery.includes(' column')) {
                const colNameMatch = query.match(/show\s+(.+)\s+column/i);
                const colName = colNameMatch ? colNameMatch[1].trim() : null;
                const foundColumn = findColumnByName(colName);
                if (foundColumn) {
                    const columnValues = rawData.map(row => row[foundColumn]);
                    analysisContent = `<p class="mt-2">Here are the **first 10 values** from the "<strong>${foundColumn}</strong>" column:</p>
                                        <div class="code-block mt-2">${columnValues.slice(0, 10).join('\n')}</div>
                                        <p class="text-sm text-secondary mt-2">There are ${columnValues.length} total values in this column.</p>`;
                    aiResponseText = `Absolutely! Here's the data for column "${foundColumn}", retrieved instantly from your local dataset.`;
                } else {
                    aiResponseText = `I couldn't find the column "<strong>${colName}</strong>". Please check your column name.`;
                }
            } else if (lowerQuery.includes('count rows') || lowerQuery.includes('number of records')) {
                const numRows = rawData.length;
                aiResponseText = `Your dataset currently contains **${numRows} rows** (records).`;
            } else if (lowerQuery.includes('describe my dataset') || lowerQuery.includes('overview of data')) {
                let numRows = rawData.length;
                let numCols = Object.keys(schema).length;
                let descriptionNarrative = `<p class="leading-relaxed mb-3">Alright, let's take a look at your dataset. It appears you have <strong>${numRows} rows</strong>, which means ${numRows} individual records, and <strong>${numCols} columns</strong>, representing ${numCols} different types of information.</p>
                                             <h5 class="text-md font-semibold mt-3 mb-2">Here's a breakdown of what I found in each column:</h5>
                                             <ul class="list-disc list-inside ml-4 space-y-2">`;

                for (const col in schema) {
                    descriptionNarrative += `<li class="font-medium">${col}: (<span class="text-accent-primary">${schema[col]}</span> type) `;
                    const values = rawData.map(row => row[col]);

                    if (schema[col] === 'number') {
                        const numericValues = values.map(Number).filter(n => !isNaN(n));
                        const { min: minVal, max: maxVal } = calculateColumnMinMax(col, rawData);
                        const avgVal = calculateColumnAverage(col, rawData);
                        const medianVal = calculateMedian(col, rawData);
                        const stdDevVal = calculateStandardDeviation(col, rawData);
                        const quartiles = calculateQuartiles(col, rawData);

                        if (numericValues.length > 0) {
                            descriptionNarrative += `This column contains numerical data, ranging from <strong>${minVal}</strong> to <strong>${maxVal}</strong>, with an average value of approximately <strong>${avgVal.toFixed(2)}</strong>.`;
                            if (medianVal !== null) descriptionNarrative += ` The median is <strong>${medianVal.toFixed(2)}</strong>.`;
                            if (stdDevVal !== null) descriptionNarrative += ` Standard deviation is <strong>${stdDevVal.toFixed(2)}</strong>.`;
                            if (quartiles.q1 !== null) descriptionNarrative += ` Q1 is <strong>${quartiles.q1}</strong>, Q3 is <strong>${quartiles.q3}</strong>, and the IQR is <strong>${quartiles.iqr}</strong>.`;
                            const correlationWithOtherNumerics = [];
                            for (const otherCol in schema) {
                                if (otherCol !== col && schema[otherCol] === 'number') {
                                    const corr = calculateCorrelation(col, otherCol, rawData);
                                    if (corr !== null && !isNaN(corr)) {
                                        correlationWithOtherNumeration.push(`${otherCol}: ${corr.toFixed(2)}`);
                                    }
                                }
                            }
                            if (correlationWithOtherNumerics.length > 0) {
                                descriptionNarrative += ` It shows correlations with other numeric columns: ${correlationWithOtherNumerics.join(', ')}.`;
                            }
                        } else {
                            descriptionNarrative += `This numeric column currently has no valid numerical entries.`;
                        }
                    } else {
                        const uniqueValues = [...new Set(values)];
                        const valueCounts = {};
                        values.forEach(v => { valueCounts[v] = (valueCounts[v] || 0) + 1; });
                        const sortedCounts = Object.entries(valueCounts).sort(([,a],[,b]) => b-a);
                        descriptionNarrative += `This column holds text information. I found <strong>${uniqueValues.length} unique values</strong>. The most frequent entries are: ${sortedCounts.slice(0, 5).map(item => `"${item[0]}" appearing ${item[1]} times`).join(', ')}.`;
                    }
                    descriptionNarrative += `</li>`;
                }
                descriptionNarrative += `</ul>`;
                analysisContent = descriptionNarrative;
                aiResponseText = `Certainly! Here's a comprehensive overview and description of your dataset, crafted to give you quick insights. This analysis was performed entirely client-side, ensuring your data's privacy.`;
            } else if (lowerQuery.includes('show schema')) {
                analysisContent = `<p class="mt-2">Here's the **schema I inferred** from your uploaded data:</p>
                                    <div class="code-block mt-2">${JSON.stringify(schema, null, 2)}</div>`;
                aiResponseText = `Certainly! I've extracted the schema for you. All schema inference happens privately in your browser.`;
            }

            else if (lowerQuery.startsWith('sum ')) {
                const colName = query.substring(4).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const sum = calculateColumnSum(foundColumn, rawData);
                    analysisContent = `<p class="text-xl text-accent-primary font-bold mt-2">The sum of "${foundColumn}" is: ${sum.toFixed(2)}</p>`;
                    aiResponseText = `Alright, I've calculated the **total sum** for the column "<strong>${foundColumn}</strong>". Here's the result:`;
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the sum for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('average ') || lowerQuery.startsWith('avg ')) {
                const colName = lowerQuery.startsWith('average ') ? query.substring(8).trim() : query.substring(4).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const average = calculateColumnAverage(foundColumn, rawData);
                    analysisContent = `<p class="text-xl text-accent-primary font-bold mt-2">The average of "${foundColumn}" is: ${average.toFixed(2)}</p>`;
                    aiResponseText = `Understood! Here's the **average value** for the "<strong>${foundColumn}</strong>" column:`;
                } else {
                        aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the average for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('median ')) {
                const colName = query.substring(7).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const median = calculateMedian(foundColumn, rawData);
                    if (median !== null) {
                        aiResponseText = `The **median** for the column "<strong>${foundColumn}</strong>" is: <strong>${median.toFixed(2)}</strong>.`;
                    } else {
                        aiResponseText = `I couldn't calculate the median for "<strong>${foundColumn}</strong>" as it contains no valid numeric data.`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the median for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('standard deviation ') || lowerQuery.startsWith('std dev ')) {
                const colName = lowerQuery.startsWith('standard deviation ') ? query.substring(19).trim() : query.substring(8).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const stdDev = calculateStandardDeviation(foundColumn, rawData);
                    if (stdDev !== null) {
                        aiResponseText = `The **standard deviation** for the column "<strong>${foundColumn}</strong>" is: <strong>${stdDev.toFixed(2)}</strong>.`;
                    } else {
                        aiResponseText = `I couldn't calculate the standard deviation for "<strong>${foundColumn}</strong>" as it contains insufficient numeric data (at least 2 values are needed).`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the standard deviation for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('quartiles ')) {
                const colName = query.substring(10).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const quartiles = calculateQuartiles(foundColumn, rawData);
                    if (quartiles.median !== null) {
                        aiResponseText = `For the column "<strong>${foundColumn}</strong>":<br>
                                            **Q1 (25th percentile)**: <strong>${quartiles.q1}</strong><br>
                                            **Median (50th percentile)**: <strong>${quartiles.median}</strong><br>
                                            **Q3 (75th percentile)**: <strong>${quartiles.q3}</strong><br>
                                            **IQR (Interquartile Range)**: <strong>${quartiles.iqr}</strong>.`;
                    } else {
                        aiResponseText = `I couldn't calculate quartiles for "<strong>${foundColumn}</strong>" as it contains no valid numeric data.`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate quartiles for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('count unique ')) {
                const colName = query.substring(13).trim();
                const foundColumn = findColumnByName(colName);
                if (foundColumn) {
                    const values = rawData.map(row => row[foundColumn]);
                    const uniqueCount = new Set(values).size;
                    aiResponseText = `The column "<strong>${foundColumn}</strong>" has **${uniqueCount} unique values**.`;
                } else {
                    aiResponseText = `I couldn't find the column "<strong>${colName}</strong>" to count unique values. Please specify a valid column name.`;
                }
            } else if (lowerQuery.startsWith('show frequency of ') || lowerQuery.startsWith('top values in ')) {
                const colName = lowerQuery.startsWith('show frequency of ') ? query.substring(18).trim() : query.substring(14).trim();
                const foundColumn = findColumnByName(colName);
                if (foundColumn) {
                    const values = rawData.map(row => row[foundColumn]);
                    const valueCounts = {};
                    values.forEach(v => { valueCounts[v] = (valueCounts[v] || 0) + 1; });
                    const sortedCounts = Object.entries(valueCounts).sort(([,a],[,b]) => b-a);

                    let frequencyList = `<ul class="list-disc list-inside ml-4 mt-2 space-y-1">`;
                    sortedCounts.slice(0, 5).forEach(([value, count]) => {
                        const percentage = ((count / values.length) * 100).toFixed(1);
                        frequencyList += `<li>"<strong>${value}</strong>": ${count} occurrences (${percentage}%)</li>`;
                    });
                    frequencyList += `</ul>`;
                    aiResponseText = `Here's the **frequency distribution** for "<strong>${foundColumn}</strong>", showing the top 5 most common values:`;
                    analysisContent = frequencyList;
                } else {
                    aiResponseText = `I couldn't find the column "<strong>${colName}</strong>" to show its frequency. Please specify a valid column name.`;
                }
            } else if (lowerQuery.startsWith('min ')) {
                const colName = query.substring(4).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const { min } = calculateColumnMinMax(foundColumn, rawData);
                    if (min !== null) {
                        aiResponseText = `For the numeric column "<strong>${foundColumn}</strong>":<br>The **minimum value** is: <strong>${min}</strong>.`;
                    } else {
                        aiResponseText = `There are no valid numeric entries in "<strong>${foundColumn}</strong>" to calculate the minimum.`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the minimum for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('max ')) {
                const colName = query.substring(4).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const { max } = calculateColumnMinMax(foundColumn, rawData);
                    if (max !== null) {
                        aiResponseText = `For the numeric column "<strong>${foundColumn}</strong>":<br>The **maximum value** is: <strong>${max}</strong>.`;
                    } else {
                        aiResponseText = `There are no valid numeric entries in "<strong>${foundColumn}</strong>" to calculate the maximum.`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to calculate the maximum for. Please specify a valid numeric column.`;
                }
            } else if (lowerQuery.startsWith('average ') && lowerQuery.includes(' by ')) {
                const parts = query.match(/average\s+(.+)\s+by\s+(.+)/i);
                if (parts && parts.length === 3) {
                    const numericColName = parts[1].trim();
                    const categoricalColName = parts[2].trim();
                    const numericColumn = findNumericColumn(numericColName);
                    const categoricalColumn = findCategoricalColumn(categoricalColName);

                    if (numericColumn && categoricalColumn) {
                        const groupedAverages = {};
                        const counts = {};

                        rawData.forEach(row => {
                            const category = row[categoricalColumn];
                            const numericValue = Number(row[numericColumn]);

                            if (!isNaN(numericValue)) {
                                if (!groupedAverages[category]) {
                                    groupedAverages[category] = 0;
                                    counts[category] = 0;
                                }
                                groupedAverages[category] += numericValue;
                                counts[category]++;
                            }
                        });

                        let resultsHtml = `<ul class="list-disc list-inside ml-4 mt-2 space-y-1">`;
                        for (const category in groupedAverages) {
                            const avg = (groupedAverages[category] / counts[category]).toFixed(2);
                            resultsHtml += `<li><strong>${category}</strong>: Average ${numericColumn} is <strong>${avg}</strong> (${counts[category]} entries)</li>`;
                        }
                        resultsHtml += `</ul>`;
                        aiResponseText = `Here's the **average of "${numericColumn}" grouped by "${categoricalColumn}"**:`;
                        analysisContent = resultsHtml;
                    } else {
                        aiResponseText = `I need both a valid numeric column and a valid categorical column to perform that aggregation. Please check your column names and types.`;
                    }
                } else {
                    aiResponseText = `I didn't understand the format for 'average by category'. Example: 'average sales by region'.`;
                }
            } else if (lowerQuery.startsWith('show correlation between ')) {
                const parts = query.match(/show correlation between\s+(.+)\s+and\s+(.+)/i);
                if (parts && parts.length === 3) {
                    const col1Name = parts[1].trim();
                    const col2Name = parts[2].trim();
                    const col1 = findNumericColumn(col1Name);
                    const col2 = findNumericColumn(col2Name);

                    if (col1 && col2) {
                        const correlation = calculateCorrelation(col1, col2, rawData);
                        if (correlation !== null) {
                            let interpretation = '';
                            if (correlation >= 0.7) interpretation = 'a **strong positive correlation**';
                            else if (correlation >= 0.3) interpretation = 'a **moderate positive correlation**';
                            else if (correlation > -0.3 && correlation < 0.3) interpretation = 'a **very weak or no linear correlation**';
                            else if (correlation > -0.7) interpretation = 'a **moderate negative correlation**';
                            else interpretation = 'a **strong negative correlation**';
                            aiResponseText = `The **Pearson correlation coefficient** between "<strong>${col1}</strong>" and "<strong>${col2}</strong>" is: <strong>${correlation.toFixed(4)}</strong>. This indicates ${interpretation}.`;
                        } else {
                            aiResponseText = `I couldn't calculate the correlation between "<strong>${col1}</strong>" and "<strong>${col2}</strong>" due to insufficient or invalid numeric data.`;
                        }
                    } else {
                        aiResponseText = `I need two valid numeric columns. Please check your column names and types.`;
                    }
                } else {
                    aiResponseText = `I didn't understand the format for 'correlation'. Example: 'show correlation between Age and Income'.`;
                }
            } else if (lowerQuery.startsWith('find outliers in ')) {
                const colName = query.substring(17).trim();
                const foundColumn = findNumericColumn(colName);
                if (foundColumn) {
                    const { outliers, lowerBound, upperBound } = findOutliers(foundColumn, rawData);
                    if (outliers.length > 0) {
                        aiResponseText = `I found **${outliers.length} potential outliers** in the column "<strong>${foundColumn}</strong>".<br>
                                            These values fall outside the IQR bounds of <strong>${lowerBound}</strong> and <strong>${upperBound}</strong>.<br>
                                            Outlier values (first 10): <strong>${outliers.slice(0, 10).join(', ')}</strong>.`;
                    } else {
                        aiResponseText = `No significant outliers were detected in the column "<strong>${foundColumn}</strong>" based on the IQR method.`;
                    }
                } else {
                    aiResponseText = `I couldn't find a numeric column named "<strong>${colName}</strong>" to find outliers. Please specify a valid numeric column.`;
                }
            }

            else if (lowerQuery.startsWith('perform t-test on ') && lowerQuery.includes(' for ') && lowerQuery.includes(' where ') && lowerQuery.includes(' vs ')) {
                const regex = /perform t-test on\s+(.+)\s+for\s+(.+)\s+where\s+(.+)\s+vs\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 5) {
                    const numericColName = match[1].trim();
                    const categoricalColName = match[2].trim();
                    const group1Value = match[3].trim();
                    const group2Value = match[4].trim();

                    const numericCol = findNumericColumn(numericColName);
                    const categoricalCol = findCategoricalColumn(categoricalColName);

                    if (numericCol && categoricalCol) {
                        const tTestResult = performTTest(numericCol, categoricalCol, group1Value, group2Value, rawData);
                        if (tTestResult.error) {
                            aiResponseText = `Error performing T-test: ${tTestResult.error}`;
                        } else {
                            aiResponseText = `**T-Test Results** for **${numericCol}** between "${group1Value}" and "${group2Value}" in **${categoricalCol}**:<br>
                                            - Mean for "${group1Value}": <strong>${tTestResult.group1Mean}</strong> (n=${tTestResult.group1Count})<br>
                                            - Mean for "${group2Value}": <strong>${tTestResult.group2Mean}</strong> (n=${tTestResult.group2Count})<br>
                                            - Calculated T-Statistic: <strong>${tTestResult.tStatistic}</strong><br>
                                            - Degrees of Freedom: <strong>${tTestResult.degreesOfFreedom}</strong><br>
                                            - **Interpretation**: ${tTestResult.interpretation}`;
                        }
                    } else {
                        aiResponseText = `To perform a T-test, I need a valid numeric column and a valid categorical column to define the groups. Please check your column names.`;
                    }
                } else {
                    aiResponseText = `I didn't understand the T-test command format. Example: 'perform t-test on Sales for Region where East vs West'.`;
                }
            }
            else if (lowerQuery.startsWith('perform anova on ') && lowerQuery.includes(' by ')) {
                const parts = query.match(/perform anova on\s+(.+)\s+by\s+(.+)/i);
                if (parts && parts.length === 3) {
                    const numericColName = parts[1].trim();
                    const categoricalColName = parts[2].trim();

                    const anovaResult = performANOVA(numericColName, categoricalColName, rawData);
                    if (anovaResult.error) {
                        aiResponseText = `Error performing ANOVA: ${anovaResult.error}`;
                    } else {
                        aiResponseText = `**One-Way ANOVA Results** for **${numericColName}** by **${categoricalColName}**:<br>
                                            - F-Statistic: <strong>${anovaResult.fStatistic}</strong><br>
                                            - Degrees of Freedom (Between Groups): <strong>${anovaResult.dfBetween}</strong><br>
                                            - Degrees of Freedom (Within Groups): <strong>${anovaResult.dfWithin}</strong><br>
                                            - Groups Analyzed: <strong>${anovaResult.groupsAnalyzed}</strong><br>
                                            - **Interpretation**: ${anovaResult.interpretation}`;
                    }
                } else {
                    aiResponseText = `I didn't understand the ANOVA command format. Example: 'perform ANOVA on Sales by Region'.`;
                }
            }
            else if (lowerQuery.startsWith('perform chi-square test on ') && lowerQuery.includes(' and ')) {
                const parts = query.match(/perform chi-square test on\s+(.+)\s+and\s+(.+)/i);
                if (parts && parts.length === 3) {
                    const col1Name = parts[1].trim();
                    const col2Name = parts[2].trim();

                    const chiSquareResult = performChiSquareTest(col1Name, col2Name, rawData);
                    if (chiSquareResult.error) {
                        aiResponseText = `Error performing Chi-Square Test: ${chiSquareResult.error}`;
                    } else {
                        aiResponseText = `**Chi-Square Test of Independence Results** for **${col1Name}** and **${col2Name}**:<br>
                                            - Chi-Square Statistic: <strong>${chiSquareResult.chiSquareStatistic}</strong><br>
                                            - Degrees of Freedom: <strong>${chiSquareResult.degreesOfFreedom}</strong><br>
                                            - **Interpretation**: ${chiSquareResult.interpretation}<br>
                                            <details><summary class="text-sm cursor-pointer text-accent-primary hover:underline">View Contingency Table (Preview)</summary><pre class="code-block mt-2">${chiSquareResult.tablePreview}</pre></details>`;
                    }
                } else {
                    aiResponseText = `I didn't understand the Chi-Square Test command format. Example: 'perform chi-square test on Gender and Purchase_Decision'.`;
                }
            }
            else if (lowerQuery.startsWith('perform mann-whitney u test on ') && lowerQuery.includes(' for ') && lowerQuery.includes(' where ') && lowerQuery.includes(' vs ')) {
                const regex = /perform mann-whitney u test on\s+(.+)\s+for\s+(.+)\s+where\s+(.+)\s+vs\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 5) {
                    const numericColName = match[1].trim();
                    const categoricalColName = match[2].trim();
                    const group1Value = match[3].trim();
                    const group2Value = match[4].trim();

                    const mwResult = performMannWhitneyU(numericColName, categoricalColName, group1Value, group2Value, rawData);
                    if (mwResult.error) {
                        aiResponseText = `Error performing Mann-Whitney U Test: ${mwResult.error}`;
                    } else {
                        aiResponseText = `**Mann-Whitney U Test Results** for **${numericColName}** (comparing "${group1Value}" vs "${group2Value}" in ${categoricalColName}):<br>
                                            - U Statistic: <strong>${mwResult.uStatistic}</strong><br>
                                            - Group 1 size (${group1Value}): <strong>${mwResult.group1Count}</strong><br>
                                            - Group 2 size (${group2Value}): <strong>${mwResult.group2Count}</strong><br>
                                            - **Interpretation**: ${mwResult.interpretation}`;
                    }
                } else {
                    aiResponseText = `I didn't understand the Mann-Whitney U test command format. Example: 'perform Mann-Whitney U test on Income for Education where High School vs College'.`;
                }
            }
            else if (lowerQuery.startsWith('calculate moving average of ') && lowerQuery.includes(' with window ') && lowerQuery.includes(' as ')) {
                const regex = /calculate moving average of\s+(.+)\s+with window\s+(\d+)\s+as\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 4) {
                    const numericColName = match[1].trim();
                    const windowSize = parseInt(match[2].trim());
                    const newColName = match[3].trim().replace(/\s/g, '_');

                    const numericCol = findNumericColumn(numericColName);

                    if (numericCol) {
                        const result = calculateMovingAverage(numericCol, windowSize, newColName, rawData);
                        aiResponseText = result.message;
                    } else {
                        aiResponseText = `I couldn't find a numeric column named "<strong>${numericColName}</strong>" to calculate moving average. Please specify a valid numeric column.`;
                    }
                } else {
                    aiResponseText = `I didn't understand the moving average command format. Example: 'calculate moving average of Stock_Price with window 5 as MA_5_Days'.`;
                }
            }

            else if (lowerQuery.startsWith('perform multiple regression with y as ') && lowerQuery.includes(' and x as ')) {
                const regex = /perform multiple regression with y as\s+(.+?)\s+and x as\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 3) {
                    const dependentColName = match[1].trim();
                    const independentColsString = match[2].trim();
                    const independentColNames = independentColsString.split(',').map(col => col.trim());

                    const dependentCol = findNumericColumn(dependentColName);
                    const independentCols = independentColNames.map(col => findNumericColumn(col)).filter(Boolean);

                    if (!dependentCol) {
                        aiResponseText = `Dependent variable "<strong>${dependentColName}</strong>" not found or is not numeric.`;
                    } else if (independentCols.length !== independentColNames.length) {
                        aiResponseText = `One or more independent variables (${independentColNames.filter(name => !findNumericColumn(name)).join(', ')}) not found or are not numeric.`;
                    } else if (independentCols.length === 0) {
                        aiResponseText = `Please provide at least one independent variable for multiple regression.`;
                    } else {
                        const regressionResult = calculateMultipleLinearRegression(dependentCol, independentCols, rawData);
                        if (regressionResult.error) {
                            aiResponseText = `Error performing multiple linear regression: ${regressionResult.error}`;
                        } else {
                            let slopesHtml = '';
                            for (const col in regressionResult.slopes) {
                                slopesHtml += `<li><strong>${col}</strong>: ${regressionResult.slopes[col]}</li>`;
                            }
                            aiResponseText = `**Multiple Linear Regression Results** (Y: ${dependentCol}):<br>
                                            - **Intercept**: <strong>${regressionResult.intercept}</strong><br>
                                            - **Slopes**: <ul>${slopesHtml}</ul>
                                            - **R-squared**: <strong>${regressionResult.rSquared}</strong><br>
                                            This model explains **${(parseFloat(regressionResult.rSquared) * 100).toFixed(2)}%** of the variance in "${dependentCol}".`;
                        }
                    }
                } else {
                    aiResponseText = `I didn't understand the multiple regression command format. Example: 'perform multiple regression with Y as Sales and X as Advertising, Price'.`;
                }
            }

            else if (lowerQuery.startsWith('perform polynomial regression with y as ') && lowerQuery.includes(' and x as ') && lowerQuery.includes(' with degree ')) {
                const regex = /perform polynomial regression with y as\s+(.+?)\s+and x as\s+(.+?)\s+with degree\s+(\d+)/i;
                const match = query.match(regex);
                if (match && match.length === 4) {
                    const dependentColName = match[1].trim();
                    const independentColName = match[2].trim();
                    const degree = parseInt(match[3].trim());

                    const dependentCol = findNumericColumn(dependentColName);
                    const independentCol = findNumericColumn(independentColName);

                    if (!dependentCol) {
                        aiResponseText = `Dependent variable "<strong>${dependentColName}</strong>" not found or is not numeric.`;
                    } else if (!independentCol) {
                        aiResponseText = `Independent variable "<strong>${independentColName}</strong>" not found or is not numeric.`;
                    } else if (degree < 2 || degree > 5) {
                        aiResponseText = `Polynomial degree must be between 2 and 5 for practical analysis.`;
                    } else {
                        const tempIndependentCols = [];
                        const tempRawData = JSON.parse(JSON.stringify(rawData));

                        for (let i = 1; i <= degree; i++) {
                            const newPolyColName = `${independentCol}_poly_${i}`;
                            tempIndependentCols.push(newPolyColName);
                            tempRawData.forEach(row => {
                                const originalValue = Number(row[independentCol]);
                                if (!isNaN(originalValue)) {
                                    row[newPolyColName] = Math.pow(originalValue, i);
                                } else {
                                    row[newPolyColName] = NaN;
                                }
                            });
                        }

                        const regressionResult = calculateMultipleLinearRegression(dependentCol, tempIndependentCols, tempRawData);

                        if (regressionResult.error) {
                            aiResponseText = `Error performing polynomial regression: ${regressionResult.error}`;
                        } else {
                            let slopesHtml = '';
                            for (const col of tempIndependentCols) {
                                slopesHtml += `<li><strong>${col}</strong>: ${regressionResult.slopes[col]}</li>`;
                            }
                            aiResponseText = `**Polynomial Regression Results** (Y: ${dependentCol}, X: ${independentCol}, Degree: ${degree}):<br>
                                            - **Intercept**: <strong>${regressionResult.intercept}</strong><br>
                                            - **Coefficients for polynomial terms**: <ul>${slopesHtml}</ul>
                                            - **R-squared**: <strong>${regressionResult.rSquared}</strong><br>
                                            This model explains **${(parseFloat(regressionResult.rSquared) * 100).toFixed(2)}%** of the variance in "${dependentCol}".`;
                        }
                    }
                } else {
                    aiResponseText = `I didn't understand the polynomial regression command format. Example: 'perform polynomial regression with Y as Sales and X as Advertising with degree 2'.`;
                }
            }

            else if (lowerQuery.startsWith('perform k-means clustering on ') && lowerQuery.includes(' into ') && lowerQuery.includes(' clusters as ')) {
                const regex = /perform k-means clustering on\s+([^,]+(?:,\s*[^,]+)*?)\s+into\s+(\d+)\s+clusters as\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 4) {
                    const featureColsString = match[1].trim();
                    const k = parseInt(match[2].trim());
                    const newColName = match[3].trim().replace(/\s/g, '_');

                    const requestedFeatureCols = featureColsString.split(',').map(col => col.trim());
                    const validFeatureCols = requestedFeatureCols.filter(name => findNumericColumn(name));

                    if (validFeatureCols.length !== requestedFeatureCols.length) {
                        aiResponseText = `One or more specified columns for clustering (${requestedFeatureCols.filter(name => !findNumericColumn(name)).join(', ')}) are not found or not numeric.`;
                    } else {
                        const clusteringResult = performKMeansClustering(validFeatureCols, k, newColName, rawData);
                        if (clusteringResult.success) {
                            let distributionHtml = '<ul>';
                            for (const cluster in clusteringResult.distribution) {
                                distributionHtml += `<li>${cluster}: <strong>${clusteringResult.distribution[cluster]} data points</strong></li>`;
                            }
                            aiResponseText = `${clusteringResult.message}<br><br>
                                            **Cluster Distribution**:<br>${distributionHtml}`;
                        } else {
                            aiResponseText = `Error performing K-Means clustering: ${clusteringResult.message}`;
                        }
                    }
                } else {
                    aiResponseText = `I didn't understand the K-Means clustering command format. Example: 'perform k-means clustering on Age, Income, Spending_Score into 3 clusters as Customer_Segment'.`;
                }
            }

            else if (lowerQuery.startsWith('create pivot table with ') && lowerQuery.includes(' as rows, ') && lowerQuery.includes(' as columns, ') && lowerQuery.includes(' as values aggregated by ')) {
                const regex = /create pivot table with\s+(.+?)\s+as rows,\s+(.+?)\s+as columns,\s+(.+?)\s+as values aggregated by\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 5) {
                    const indexCol = match[1].trim();
                    const pivotCol = match[2].trim();
                    const valueCol = match[3].trim();
                    const aggType = match[4].trim();

                    const pivotResult = createPivotTable(indexCol, pivotCol, valueCol, aggType, rawData);
                    if (pivotResult.error) {
                        aiResponseText = `Error creating pivot table: ${pivotResult.error}`;
                    } else {
                        aiResponseText = `Here's your **pivot table** for ${valueCol} aggregated by ${aggType}:`;
                        analysisContent = `<div class="mt-4 overflow-x-auto">${pivotResult.tableHtml}</div>
                                            <p class="mt-4 text-sm text-secondary">This pivot table provides a summarized view of your data, transformed entirely client-side.</p>`;
                    }
                } else {
                    aiResponseText = `I didn't understand the pivot table command format. Example: 'create pivot table with Region as rows, Product_Category as columns, Sales as values aggregated by sum'.`;
                }
            }
            else if (lowerQuery.startsWith('unpivot data keeping ') && lowerQuery.includes(' and melting ') && lowerQuery.includes(' into new variable ') && lowerQuery.includes(' and value ')) {
                const regex = /unpivot data keeping\s+([^,]+(?:,\s*[^,]+)*?)\s+and melting\s+([^,]+(?:,\s*[^,]+)*?)\s+into new variable\s+(.+?)\s+and value\s+(.+)/i;
                const match = query.match(regex);
                if (match && match.length === 5) {
                    const idColsString = match[1].trim();
                    const colsToUnpivotString = match[2].trim();
                    const newVarCol = match[3].trim();
                    const newValCol = match[4].trim();

                    const idCols = idColsString.split(',').map(col => col.trim());
                    const colsToUnpivot = colsToUnpivotString.split(',').map(col => col.trim());

                    const unpivotResult = unpivotData(idCols, colsToUnpivot, newVarCol, newValCol, rawData, schema);
                    if (unpivotResult.success) {
                        aiResponseText = unpivotResult.message;
                        analysisContent = `<p class="mt-2">Your data has been unpivoted successfully. Here's a preview of the **first 10 rows** of the transformed dataset:</p>
                                            <div class="code-block mt-2">${rawData.slice(0, 10).map(row => JSON.stringify(row, null, 2)).join('\n')}</div>
                                            <p class="text-sm text-secondary mt-2">The schema has also been updated to reflect these changes.</p>`;
                    } else {
                        aiResponseText = `Error unpivoting data: ${unpivotResult.message}`;
                    }
                } else {
                    aiResponseText = `I didn't understand the unpivot data command format. Example: 'unpivot data keeping ID and melting Q1_Sales, Q2_Sales, Q3_Sales into new variable Quarter and value Sales_Amount'.`;
                }
            }

            else if (lowerQuery.includes('show proactive insights') || lowerQuery.includes('what insights do you have?')) {
                if (rawData.length === 0) {
                    appendMessage('AI', 'Please upload a CSV file before I can generate proactive insights. I need data to analyze!', 'ai');
                    return;
                }
                generateProactiveInsights();
                renderProactiveInsights();
                proactiveInsightsOverlay.classList.remove('hidden');
                // Ensure the overlay shows with transition
                proactiveInsightsOverlay.classList.add('show');
                return;
            }

            else if (lowerQuery.startsWith('show bar chart of ') || lowerQuery.startsWith('show line chart with x as ') || lowerQuery.startsWith('show scatter plot with x as ') || lowerQuery.startsWith('show pie chart of ') || lowerQuery.startsWith('show doughnut chart of ') || lowerQuery.startsWith('show polar area chart of ')) {
                let chartType = '';
                let queryRemainder = '';

                // Determine chart type and extract remainder of query
                if (lowerQuery.startsWith('show bar chart of ')) {
                    chartType = 'bar';
                    queryRemainder = query.substring('show bar chart of '.length).trim();
                } else if (lowerQuery.startsWith('show line chart with x as ')) {
                    chartType = 'line';
                    queryRemainder = query.substring('show line chart with x as '.length).trim();
                } else if (lowerQuery.startsWith('show scatter plot with x as ')) {
                    chartType = 'scatter';
                    queryRemainder = query.substring('show scatter plot with x as '.length).trim();
                } else if (lowerQuery.startsWith('show pie chart of ')) {
                    chartType = 'pie';
                    queryRemainder = query.substring('show pie chart of '.length).trim();
                } else if (lowerQuery.startsWith('show doughnut chart of ')) {
                    chartType = 'doughnut';
                    queryRemainder = query.substring('show doughnut chart of '.length).trim();
                } else if (lowerQuery.startsWith('show polar area chart of ')) {
                    chartType = 'polarArea';
                    queryRemainder = query.substring('show polar area chart of '.length).trim();
                }

                // Handle different chart command formats
                if (chartType === 'scatter' || chartType === 'line') {
                    const parts = queryRemainder.match(/^(.*?) and y as (.*)$/i);
                    if (parts && parts.length === 3) {
                        const xColName = parts[1].trim();
                        const yColName = parts[2].trim();
                        const xCol = findColumnByName(xColName);
                        const yCol = findNumericColumn(yColName);

                        if (xCol && yCol) {
                            const chartData = rawData.map(row => {
                                const xVal = schema[xCol] === 'number' ? Number(row[xCol]) : row[xCol];
                                const yVal = Number(row[yCol]);
                                return (!isNaN(yVal) && xVal !== undefined && xVal !== null && xVal !== '') ? { x: xVal, y: yVal } : null;
                            }).filter(Boolean);

                            if (chartData.length > 0) {
                                // For line and scatter, if x is numeric, sort numerically. Otherwise, sort alphabetically.
                                if (schema[xCol] === 'number') {
                                    chartData.sort((a, b) => a.x - b.x);
                                } else {
                                    chartData.sort((a, b) => String(a.x).localeCompare(String(b.x)));
                                }

                                const labels = chartData.map(d => d.x);
                                const data = chartData.map(d => d.y);

                                createChart(chartType, `${yCol} vs ${xCol}`, labels, data, xCol, yCol, {
                                    scales: {
                                        x: { type: schema[xCol] === 'number' ? 'linear' : 'category', position: 'bottom', title: { display: true, text: xCol, color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() } },
                                        y: { type: 'linear', title: { display: true, text: yCol, color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() } }
                                    }
                                });
                            } else {
                                aiResponseText = `No valid data to create a ${chartType} chart for "${xCol}" and "${yCol}". Ensure both columns have valid data and "${yCol}" is numeric.`;
                            }
                        } else {
                            aiResponseText = `To show a ${chartType} chart, I need valid X and Y columns. Y must be numeric. Please check your column names.`;
                        }
                    } else {
                        aiResponseText = `I didn't understand the ${chartType} chart command format. Example: 'show ${chartType} with X as Date and Y as Stock Price'.`;
                    }
                } else { // Handle bar, pie, doughnut, polarArea charts (grouped by categorical)
                    const aggregatedParts = queryRemainder.match(/(.+)\s+by\s+(.+)(?:\s+as\s+(sum|average))?/i);
                    if (aggregatedParts && aggregatedParts.length >= 3) {
                        const numericColName = aggregatedParts[1].trim();
                        const categoricalColName = aggregatedParts[2].trim();
                        const aggregateType = aggregatedParts[4] ? aggregatedParts[4].toLowerCase() : 'sum';

                        const numericCol = findNumericColumn(numericColName);
                        const categoricalCol = findCategoricalColumn(categoricalColName);

                        if (numericCol && categoricalCol) {
                            const { labels, data: aggregatedData } = groupByAndAggregate(rawData, categoricalCol, numericCol, aggregateType);
                            if (labels.length > 0) {
                                createChart(chartType, `${numericCol} by ${categoricalCol} (${aggregateType})`, labels, aggregatedData, categoricalCol, `${numericCol} (${aggregateType})`);
                            } else {
                                aiResponseText = `No valid data to create a ${chartType} chart for "<strong>${numericCol}</strong>" by "<strong>${categoricalCol}</strong>". Ensure columns have data.`;
                            }
                        } else {
                            aiResponseText = `To show a ${chartType} chart with aggregation, I need a valid numeric column and a valid categorical column. Please check your column names.`;
                        }
                    } else { // Handle pie, doughnut, polarArea charts (frequency distribution of single categorical)
                        const categoricalColName = queryRemainder;
                        const categoricalCol = findCategoricalColumn(categoricalColName);

                        if (categoricalCol) {
                            const { labels, data: counts } = getFrequencyDistribution(categoricalCol, rawData);
                            if (labels.length > 0) {
                                createChart(chartType, `Distribution of ${categoricalCol}`, labels, counts);
                            } else {
                                aiResponseText = `No valid data to create a ${chartType} chart for "<strong>${categoricalCol}</strong>". Ensure the column has data.`;
                            }
                        } else {
                            aiResponseText = `I couldn't find a valid categorical column named "<strong>${categoricalColName}</strong>" or I didn't understand the command format for this chart. Example: 'show ${chartType} chart of Gender' or 'show ${chartType} chart of Sales by Region as sum'.`;
                        }
                    }
                }
            }
            else if (lowerQuery.includes('show command guide')) {
                commandGuideOverlay.classList.remove('hidden');
                commandGuideContent.innerHTML = getCommandListHtml();
                toggleCommandGuideText.textContent = 'Hide Command Guide';
                toggleCommandGuideBtn.querySelector('i').className = 'fas fa-book-open mr-2';
                return;
            }
            else if (lowerQuery.includes('generate data story') || lowerQuery.includes('create report')) {
                if (rawData.length === 0) {
                    appendMessage('AI', 'Please upload a CSV file before I can generate a data story. I need data to tell a story about!', 'ai');
                    return;
                }
                const reportResult = generateDataStory();
                if (reportResult && reportResult.success) {
                    aiResponseText = `Here's a concise **Data Story** based on your loaded dataset. This provides a high-level narrative of key findings.<br>`;
                    analysisContent = `<div class="bg-primary p-6 rounded-lg mt-4 shadow-xl overflow-y-auto custom-scrollbar max-h-[400px] text-primary">${reportResult.htmlContent}</div>
                                        <button id="downloadDataStoryBtn" class="send-button-gradient p-3 rounded-2xl shadow-lg focus:outline-none focus:ring-4 flex items-center justify-center space-x-2 mt-4 text-base font-bold mx-auto">
                                            <i class="fas fa-file-download"></i>
                                            <span>Download Data Story (.txt)</span>
                                        </button>`;
                    setTimeout(() => {
                        const downloadBtn = document.getElementById('downloadDataStoryBtn');
                        if (downloadBtn) {
                            downloadBtn.addEventListener('click', () => {
                                if (typeof downloadDataStory === 'function') {
                                    downloadDataStory(reportResult.reportText); // Pass raw text for download
                                } else {
                                    console.error("downloadDataStory function is not defined.");
                                }
                            });
                        }
                    }, 0);
                } else {
                    aiResponseText = `Error generating data story: ${reportResult ? reportResult.message : 'Unknown error.'}`;
                }
            }


            else {
                aiResponseText = `I'm sorry, I didn't understand that command. Please refer to the command list by typing 'show command guide' for examples, or try rephrasing your request.`;
            }
            
            if (aiResponseText || analysisContent) {
                appendMessage('AI', aiResponseText + (analysisContent ? `<div class="mt-4">${analysisContent}</div>` : ''), 'ai');
            }

            if (lowerQuery.includes('show all data') || lowerQuery.includes('display everything') || lowerQuery.includes('what\'s in the dataset')) {
                attachTableSortingListeners();
            }
        }

        sendMessageBtn.addEventListener('click', () => {
            const query = chatInput.value.trim();
            if (query) {
                appendMessage('You', query, 'user');
                chatInput.value = '';

                if (!isHeaderShrunk) {
                    headerContainer.classList.add('header-shrunk');
                    isHeaderShrunk = true;
                }

                simulateAIResponse(query);
            }
        });

        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessageBtn.click();
            }
        });

        showProactiveInsightsBtn.addEventListener('click', () => {
            if (rawData.length === 0) {
                appendMessage('AI', 'Please upload a CSV file before I can generate proactive insights. I need data to analyze!', 'ai');
                return;
            }
            generateProactiveInsights();
            renderProactiveInsights();
            proactiveInsightsOverlay.classList.remove('hidden');
            // Ensure the overlay shows with transition
            proactiveInsightsOverlay.classList.add('show');
        });

        closeProactiveInsightsBtn.addEventListener('click', () => {
            // Hide the overlay explicitly by removing the .show class
            proactiveInsightsOverlay.classList.remove('show');
            setTimeout(() => {
                proactiveInsightsOverlay.classList.add('hidden'); // Fully hide after transition
            }, 300); // Match CSS transition duration
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active');
                });

                button.classList.add('active');

                const filterType = button.dataset.filter;
                const searchTerm = insightSearchInput.value.trim();
                renderProactiveInsights(filterType, searchTerm);
            });
        });

        insightSearchInput.addEventListener('input', () => {
            const activeFilterButton = document.querySelector('.filter-btn.active');
            const filterType = activeFilterButton ? activeFilterButton.dataset.filter : 'all';
            const searchTerm = insightSearchInput.value.trim();
            renderProactiveInsights(filterType, searchTerm);
        });

        toggleCommandGuideText.textContent = 'Show Command Guide';
        toggleCommandGuideBtn.querySelector('i').className = 'fas fa-book mr-2';

        displaySchema(schema);

        function generateDataStory() {
            if (rawData.length === 0) {
                return { success: false, message: "No data loaded to generate a story." };
            }

            let storyHtml = `<h3 class="text-2xl font-bold mb-4">Your Data Story: Initial Overview</h3>
                            <p class="mb-4">This report provides a high-level summary of your dataset and key insights.</p>`;

            const numRows = rawData.length;
            const numCols = Object.keys(schema).length;
            storyHtml += `<h4 class="text-xl font-semibold mb-2">Dataset Summary:</h4>
                          <p class="mb-4">Your dataset contains <strong>${numRows} rows</strong> and <strong>${numCols} columns</strong>.</p>`;

            const numericColumns = Object.keys(schema).filter(col => schema[col] === 'number');
            if (numericColumns.length > 0) {
                storyHtml += `<h4 class="text-xl font-semibold mt-4 mb-2">Key Numeric Trends:</h4><ul>`;
                numericColumns.slice(0, 3).forEach(col => {
                    const stats = getDescriptiveStats(col, rawData);
                    if (stats) {
                        storyHtml += `<li><strong>${col}</strong>: Average of ${stats.mean.toFixed(2)}, ranging from ${stats.min.toFixed(2)} to ${stats.max.toFixed(2)}.</li>`;
                    }
                });
                storyHtml += `</ul>`;
            }

            if (lastProactiveInsights.length > 0) {
                storyHtml += `<h4 class="text-xl font-semibold mt-4 mb-2">Highlighted Insights:</h4>`;
                lastProactiveInsights.slice(0, 5).forEach(insight => {
                    storyHtml += `<div class="insight-card p-4 my-2 border rounded-lg">
                                    <h5 class="font-bold mb-1 flex items-center"><i class="${insight.icon} mr-2"></i>${insight.title}</h5>
                                    <p class="text-sm">${insight.message.split('<br>')[0].replace('<strong>', '').replace('</strong>', '')}</p>
                                  </div>`;
                });
                storyHtml += `<p class="mt-4">For a full list and details, click "Show Proactive Insights".</p>`;
            } else {
                storyHtml += `<p class="mt-4">No specific proactive insights generated yet. Upload data and look for the "Show Proactive Insights" button!</p>`;
            }

            storyHtml += `<p class="mt-6 italic">This story is automatically generated and provides a starting point for your analysis.</p>`;

            return { success: true, htmlContent: storyHtml, reportText: storyHtml.replace(/<[^>]*>/g, '') }; // Return both HTML and plain text
        }

        function downloadDataStory(text) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'CoDA_Data_Story.txt');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            appendMessage('AI', 'Your data story has been downloaded as **CoDA_Data_Story.txt**!', 'ai');
        }
    </script>
</body>
</html>
